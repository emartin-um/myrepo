---
title: "Apply Sample Filters"
format:
  html:
    toc: true
    toc-float: true
    toc-depth: 3
editor: visual
---

# Overview

Apply sample exclusion filters based on the exclusion report generated by File_Merge.qmd. This script:

1. Reads the exclusion report
2. Filters merged datasets to remove excluded samples
3. Outputs filtered datasets
4. Provides summary statistics

## Load Libraries and Data

```{r}
#| label: setup
#| message: false
#| echo: false

library(tidyverse)
library(knitr)
library(kableExtra)

# Read exclusion report
exclusion_report <- read_csv("output_files/sample_exclusion_report.csv")

# Read merged files
merged_standard <- read_csv("output_files/merged_standard_post_QC.csv")
merged_low <- read_csv("output_files/merged_low_post_QC.csv")
merged_combined <- read_csv("output_files/merged_combined_post_QC.csv")

cat("Files loaded successfully.\n")
```

## Exclusion Report Summary

```{r}
#| label: exclusion-summary
#| echo: false
#| results: asis

cat("=== EXCLUSION REPORT SUMMARY ===\n\n")
cat("Total samples in exclusion report:", nrow(exclusion_report), "\n")
cat("Samples flagged for EXCLUSION:", sum(exclusion_report$exclude), "\n")
cat("Samples to KEEP:", sum(!exclusion_report$exclude), "\n\n")

# Show exclusion reasons breakdown
if (sum(exclusion_report$exclude) > 0) {
  cat("Exclusion reasons:\n")
  exclusion_breakdown <- exclusion_report %>%
    filter(exclude) %>%
    count(exclude_reason) %>%
    arrange(desc(n))

  print(kable(exclusion_breakdown,
              col.names = c("Exclusion Reason", "Count"),
              caption = "Breakdown of Exclusion Reasons") %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed")))
}
```

## Samples to Exclude

```{r}
#| label: show-excluded
#| echo: false
#| results: asis

excluded_samples <- exclusion_report %>%
  filter(exclude) %>%
  arrange(SAMPLE)

if (nrow(excluded_samples) > 0) {
  cat("\n### List of Excluded Samples\n\n")
  print(kable(excluded_samples,
              caption = paste0("Samples Being Excluded (n=", nrow(excluded_samples), ")")) %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed")))
} else {
  cat("No samples flagged for exclusion.\n")
}
```

## Apply Filters to Merged Datasets

```{r}
#| label: apply-filters
#| echo: false

# Get list of SAMPLE_ALIQUOTs to keep (those NOT flagged for exclusion)
samples_to_keep <- exclusion_report %>%
  filter(!exclude) %>%
  pull(SAMPLE_ALIQUOT)

cat("\n=== APPLYING FILTERS ===\n\n")
cat("Samples to keep:", length(samples_to_keep), "\n\n")

# Filter merged_standard
filtered_standard <- merged_standard %>%
  filter(SAMPLE_ALIQUOT %in% samples_to_keep)

cat("Merged Standard:\n")
cat("  Before filtering:", nrow(merged_standard), "rows\n")
cat("  After filtering:", nrow(filtered_standard), "rows\n")
cat("  Removed:", nrow(merged_standard) - nrow(filtered_standard), "rows\n\n")

# Filter merged_low
filtered_low <- merged_low %>%
  filter(SAMPLE_ALIQUOT %in% samples_to_keep)

cat("Merged Low:\n")
cat("  Before filtering:", nrow(merged_low), "rows\n")
cat("  After filtering:", nrow(filtered_low), "rows\n")
cat("  Removed:", nrow(merged_low) - nrow(filtered_low), "rows\n\n")

# Filter merged_combined
filtered_combined <- merged_combined %>%
  filter(SAMPLE_ALIQUOT %in% samples_to_keep)

cat("Merged Combined:\n")
cat("  Before filtering:", nrow(merged_combined), "rows\n")
cat("  After filtering:", nrow(filtered_combined), "rows\n")
cat("  Removed:", nrow(merged_combined) - nrow(filtered_combined), "rows\n")
```

## Post-Filter Data Summary

```{r}
#| label: post-filter-summary
#| echo: false
#| results: asis

cat("\n=== FILTERED DATASET SUMMARIES ===\n\n")

# Summary for filtered_combined (most comprehensive)
cat("Filtered Combined Dataset Summary:\n")
cat("  Total samples:", nrow(filtered_combined), "\n")
cat("  Total columns:", ncol(filtered_combined), "\n\n")

# Group breakdown
if ("Group" %in% names(filtered_combined)) {
  group_summary <- filtered_combined %>%
    count(Group) %>%
    arrange(desc(n))

  cat("Samples by Group:\n")
  print(kable(group_summary, col.names = c("Group", "Count")) %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed")))
}

# Case/Control breakdown
if ("Case_Control" %in% names(filtered_combined)) {
  case_control_summary <- filtered_combined %>%
    count(Case_Control) %>%
    arrange(desc(n))

  cat("\nSamples by Case/Control:\n")
  print(kable(case_control_summary, col.names = c("Case/Control", "Count")) %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed")))
}

# Sex breakdown
if ("sex" %in% names(filtered_combined)) {
  sex_summary <- filtered_combined %>%
    count(sex) %>%
    arrange(desc(n))

  cat("\nSamples by Sex:\n")
  print(kable(sex_summary, col.names = c("Sex", "Count")) %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed")))
}

# Age summary
if ("age_at_subject" %in% names(filtered_combined)) {
  age_stats <- filtered_combined %>%
    summarise(
      N = sum(!is.na(age_at_subject)),
      Mean = round(mean(age_at_subject, na.rm = TRUE), 1),
      SD = round(sd(age_at_subject, na.rm = TRUE), 1),
      Min = round(min(age_at_subject, na.rm = TRUE), 1),
      Median = round(median(age_at_subject, na.rm = TRUE), 1),
      Max = round(max(age_at_subject, na.rm = TRUE), 1)
    )

  cat("\nAge Distribution:\n")
  print(kable(age_stats, caption = "Age at Subject (years)") %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed")))
}
```

## Verify No Duplicates Remain

```{r}
#| label: verify-no-duplicates
#| echo: false
#| results: asis

cat("\n=== VERIFICATION: CHECK FOR REMAINING DUPLICATES ===\n\n")

# Check filtered_combined for any duplicate SAMPLEs
dup_check <- filtered_combined %>%
  count(SAMPLE) %>%
  filter(n > 1)

if (nrow(dup_check) > 0) {
  cat("⚠️ WARNING: Found", nrow(dup_check), "duplicate SAMPLEs in filtered data!\n\n")
  print(kable(dup_check, col.names = c("SAMPLE", "Count")) %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed")))
} else {
  cat("✓ No duplicate SAMPLEs found in filtered data.\n")
  cat("  Each SAMPLE appears exactly once.\n")
}

# Check for duplicate SAMPLE_ALIQUOTs
dup_aliquot_check <- filtered_combined %>%
  count(SAMPLE_ALIQUOT) %>%
  filter(n > 1)

if (nrow(dup_aliquot_check) > 0) {
  cat("\n⚠️ WARNING: Found", nrow(dup_aliquot_check), "duplicate SAMPLE_ALIQUOTs in filtered data!\n\n")
  print(kable(dup_aliquot_check, col.names = c("SAMPLE_ALIQUOT", "Count")) %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed")))
} else {
  cat("\n✓ No duplicate SAMPLE_ALIQUOTs found in filtered data.\n")
  cat("  Each SAMPLE_ALIQUOT is unique.\n")
}
```

## Verify No Implausible Values Remain

```{r}
#| label: verify-no-implausible
#| echo: false
#| results: asis

cat("\n=== VERIFICATION: CHECK FOR REMAINING IMPLAUSIBLE VALUES ===\n\n")

# Define plausible ranges (same as in File_Merge.qmd)
plausible_ranges <- list(
  age_at_subject = c(40, 120),
  AOO = c(30, 120),
  Years_Onset = c(0, 70),
  height_inches = c(36, 96),
  weight_lb = c(50, 500),
  BMI = c(10, 70)
)

implausible_found <- FALSE

for (var in names(plausible_ranges)) {
  if (var %in% names(filtered_combined)) {
    outliers <- filtered_combined %>%
      filter(!is.na(.data[[var]]) &
             (.data[[var]] < plausible_ranges[[var]][1] |
              .data[[var]] > plausible_ranges[[var]][2]))

    if (nrow(outliers) > 0) {
      implausible_found <- TRUE
      cat("⚠️ WARNING: Found", nrow(outliers), "implausible values for", var, "\n")

      outlier_details <- outliers %>%
        select(SAMPLE_ALIQUOT, SAMPLE, all_of(var))

      print(kable(outlier_details) %>%
              kable_styling(bootstrap_options = c("striped", "hover", "condensed")))
      cat("\n")
    }
  }
}

if (!implausible_found) {
  cat("✓ No implausible values found in filtered data.\n")
  cat("  All numeric values are within expected ranges.\n")
}
```

## Write Filtered Datasets

```{r}
#| label: write-filtered
#| echo: false

# Create output directory if needed
if (!dir.exists("output_files/filtered")) {
  dir.create("output_files/filtered")
}

# Write filtered files
write_csv(filtered_standard, "output_files/filtered/filtered_standard_post_QC.csv")
write_csv(filtered_low, "output_files/filtered/filtered_low_post_QC.csv")
write_csv(filtered_combined, "output_files/filtered/filtered_combined_post_QC.csv")

cat("\n=== FILTERED FILES WRITTEN ===\n\n")
cat("Filtered datasets written to output_files/filtered/\n\n")
cat("Files created:\n")
cat("  - filtered_standard_post_QC.csv (", nrow(filtered_standard), "rows ×",
    ncol(filtered_standard), "columns)\n")
cat("  - filtered_low_post_QC.csv (", nrow(filtered_low), "rows ×",
    ncol(filtered_low), "columns)\n")
cat("  - filtered_combined_post_QC.csv (", nrow(filtered_combined), "rows ×",
    ncol(filtered_combined), "columns)\n")
```

## Comparison: Before vs After Filtering

```{r}
#| label: before-after-comparison
#| echo: false
#| results: asis

comparison <- data.frame(
  Dataset = c("Standard Post-QC", "Low Post-QC", "Combined Post-QC"),
  Before_Filtering = c(nrow(merged_standard), nrow(merged_low), nrow(merged_combined)),
  After_Filtering = c(nrow(filtered_standard), nrow(filtered_low), nrow(filtered_combined)),
  Samples_Removed = c(
    nrow(merged_standard) - nrow(filtered_standard),
    nrow(merged_low) - nrow(filtered_low),
    nrow(merged_combined) - nrow(filtered_combined)
  )
) %>%
  mutate(
    Percent_Removed = round(Samples_Removed / Before_Filtering * 100, 1)
  )

cat("\n=== FILTERING SUMMARY ===\n\n")
print(kable(comparison,
            caption = "Sample Counts Before and After Filtering") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")))

cat("\n\nFiltering complete! Use the filtered datasets in output_files/filtered/ for downstream analyses.\n")
```
