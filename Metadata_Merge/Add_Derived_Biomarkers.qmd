---
title: "Add Derived Biomarkers"
format:
  html:
    toc: true
    toc-float: true
    toc-depth: 3
editor: visual
---

# Overview

This script adds derived biomarker columns to the filtered post-QC datasets:

1.  **APOE4_minus_APOE**: APOE4 NPQ values minus APOE NPQ values
2.  **ABeta42_minus_ABeta40**: A_42 NPQ values minus A_40 NPQ values

These derived biomarkers can be useful for downstream analyses examining the difference between related analytes.

## Load Libraries and Data

```{r}
#| label: setup
#| message: false
#| echo: false

library(tidyverse)
library(knitr)
library(kableExtra)

# Read filtered files
filtered_combined <- read_csv("output_files/filtered/filtered_combined_post_QC.csv")
filtered_standard <- read_csv("output_files/filtered/filtered_standard_post_QC.csv")

cat("Files loaded successfully.\n\n")
cat("Filtered Combined: ", nrow(filtered_combined), " rows x ", ncol(filtered_combined), " columns\n")
cat("Filtered Standard: ", nrow(filtered_standard), " rows x ", ncol(filtered_standard), " columns\n")
```

## Verify Source Columns Exist

```{r}
#| label: verify-columns
#| echo: false
#| results: asis

cat("=== VERIFYING SOURCE COLUMNS ===\n\n")

# Check for required columns in combined dataset
required_cols <- c("APOE", "APOE4", "A_40", "A_42")
missing_combined <- required_cols[!required_cols %in% names(filtered_combined)]
missing_standard <- required_cols[!required_cols %in% names(filtered_standard)]

if (length(missing_combined) > 0) {
  cat("WARNING: Missing columns in filtered_combined:", paste(missing_combined, collapse = ", "), "\n")
} else {
  cat("All required columns present in filtered_combined.\n")
}

if (length(missing_standard) > 0) {
  cat("WARNING: Missing columns in filtered_standard:", paste(missing_standard, collapse = ", "), "\n")
} else {
  cat("All required columns present in filtered_standard.\n")
}
```

## Create Derived Biomarkers

```{r}
#| label: create-derived
#| echo: false

cat("\n=== CREATING DERIVED BIOMARKERS ===\n\n")

# Add derived columns to filtered_combined
filtered_combined <- filtered_combined %>%
  mutate(
    APOE4_minus_APOE = APOE4 - APOE,
    ABeta42_minus_ABeta40 = A_42 - A_40
  )

# Add derived columns to filtered_standard
filtered_standard <- filtered_standard %>%
  mutate(
    APOE4_minus_APOE = APOE4 - APOE,
    ABeta42_minus_ABeta40 = A_42 - A_40
  )

cat("Derived biomarkers added:\n")
cat("  - APOE4_minus_APOE (APOE4 - APOE)\n")
cat("  - ABeta42_minus_ABeta40 (A_42 - A_40)\n\n")

cat("Updated dimensions:\n")
cat("  Filtered Combined: ", nrow(filtered_combined), " rows x ", ncol(filtered_combined), " columns\n")
cat("  Filtered Standard: ", nrow(filtered_standard), " rows x ", ncol(filtered_standard), " columns\n")
```

## Summary Statistics for Derived Biomarkers

```{r}
#| label: summary-stats
#| echo: false
#| results: asis

cat("\n=== SUMMARY STATISTICS FOR DERIVED BIOMARKERS ===\n\n")

# Summary for APOE4_minus_APOE
apoe_diff_stats <- filtered_combined %>%
  summarise(
    N = sum(!is.na(APOE4_minus_APOE)),
    N_Missing = sum(is.na(APOE4_minus_APOE)),
    Mean = round(mean(APOE4_minus_APOE, na.rm = TRUE), 4),
    SD = round(sd(APOE4_minus_APOE, na.rm = TRUE), 4),
    Min = round(min(APOE4_minus_APOE, na.rm = TRUE), 4),
    Median = round(median(APOE4_minus_APOE, na.rm = TRUE), 4),
    Max = round(max(APOE4_minus_APOE, na.rm = TRUE), 4)
  )

cat("### APOE4_minus_APOE (APOE4 - APOE)\n\n")
print(kable(apoe_diff_stats, caption = "APOE4 minus APOE Summary") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")))

# Summary for ABeta42_minus_ABeta40
abeta_diff_stats <- filtered_combined %>%
  summarise(
    N = sum(!is.na(ABeta42_minus_ABeta40)),
    N_Missing = sum(is.na(ABeta42_minus_ABeta40)),
    Mean = round(mean(ABeta42_minus_ABeta40, na.rm = TRUE), 4),
    SD = round(sd(ABeta42_minus_ABeta40, na.rm = TRUE), 4),
    Min = round(min(ABeta42_minus_ABeta40, na.rm = TRUE), 4),
    Median = round(median(ABeta42_minus_ABeta40, na.rm = TRUE), 4),
    Max = round(max(ABeta42_minus_ABeta40, na.rm = TRUE), 4)
  )

cat("\n### ABeta42_minus_ABeta40 (A_42 - A_40)\n\n")
print(kable(abeta_diff_stats, caption = "ABeta42 minus ABeta40 Summary") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")))
```

## Distribution Plots

```{r}
#| label: distribution-plots
#| echo: false
#| fig-width: 10
#| fig-height: 4

# Create distribution plots
p1 <- ggplot(filtered_combined, aes(x = APOE4_minus_APOE)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "white", alpha = 0.7) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", linewidth = 1) +
  labs(
    title = "Distribution of APOE4 - APOE",
    x = "APOE4_minus_APOE (NPQ)",
    y = "Count"
  ) +
  theme_minimal()

p2 <- ggplot(filtered_combined, aes(x = ABeta42_minus_ABeta40)) +
  geom_histogram(bins = 50, fill = "darkgreen", color = "white", alpha = 0.7) +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed", linewidth = 1) +
  labs(
    title = "Distribution of ABeta42 - ABeta40",
    x = "ABeta42_minus_ABeta40 (NPQ)",
    y = "Count"
  ) +
  theme_minimal()

# Display plots side by side
library(patchwork)
p1 + p2
```

## Write Updated Files

```{r}
#| label: write-files
#| echo: false

# Write updated files (same filenames)
write_csv(filtered_combined, "output_files/filtered/filtered_combined_post_QC.csv")
write_csv(filtered_standard, "output_files/filtered/filtered_standard_post_QC.csv")

cat("\n=== FILES UPDATED ===\n\n")
cat("Updated files written to output_files/filtered/\n\n")
cat("Files updated:\n")
cat("  - filtered_combined_post_QC.csv (", nrow(filtered_combined), " rows x ",
    ncol(filtered_combined), " columns)\n")
cat("  - filtered_standard_post_QC.csv (", nrow(filtered_standard), " rows x ",
    ncol(filtered_standard), " columns)\n")
cat("\nNew biomarker columns added:\n")
cat("  - APOE4_minus_APOE\n")
cat("  - ABeta42_minus_ABeta40\n")
```

## Verify New Columns

```{r}
#| label: verify-new-columns
#| echo: false
#| results: asis

cat("\n=== VERIFICATION: NEW COLUMNS PRESENT ===\n\n")

# Show a sample of the new columns
sample_data <- filtered_combined %>%
  select(SAMPLE_ALIQUOT, APOE, APOE4, APOE4_minus_APOE, A_40, A_42, ABeta42_minus_ABeta40) %>%
  head(10)

cat("Sample of source and derived columns (first 10 rows):\n\n")
print(kable(sample_data,
            digits = 4,
            caption = "Sample Data with Derived Biomarkers") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")))

cat("\n\nDerived biomarkers successfully added to filtered datasets.\n")
```
