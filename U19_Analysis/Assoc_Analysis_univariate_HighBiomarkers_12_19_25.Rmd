---
title: "Association Analysis of High-Count/High-Detectability Biomarkers in U19 Data"
author: "ERM"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 5
    toc_float: true
    code_folding: hide
---

# A. Overview

This report is an examination of the High-Count and High-Detectability biomarkers after primary QC. As of 12/19/25 we are adding in ALZ3. Redone 12/21/25 with correctly merged ALZ123 datasets.

## A.1 Input Data

**Data Source:** This analysis uses the merged dataset from Metadata_Merge, which combines biomarker data with sample metadata.

**Output Data Files:** Analyst should create a folder `output_files` in the working directory.

## A.2 Thresholds

Adjustable QC parameters include:

| Parameter | Default | Description |
|-----------|---------|-------------|
| `FDR` | 0.05 | Within-group FDR adjustment|

---

## A.3 Initial Setup

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)

# Source shared utility functions
source("../Utilities/shared_functions.R")

# Create output folder if it doesn't exist
if (!dir.exists("output_files")) dir.create("output_files")

# Thresholds
FDR <- 0.05

```

## A.4 Load Data

Data is loaded from Metadata_Merge output (the merged biomarker + metadata dataset).

```{r load-and-format, message=FALSE, warning=FALSE, echo=TRUE, results='asis'}
library(tidyverse)

# --- Load merged data from Metadata_Merge ---
input_file <- "input_files/filtered_combined_post_QC.csv"
fallback_file <- "../Metadata_Merge/output_files/filtered/filtered_combined_post_QC.csv"

if (file.exists(input_file)) {
  df <- read_csv(input_file, show_col_types = FALSE)
  cat("**Data loaded from:** `", input_file, "`\n\n")
} else if (file.exists(fallback_file)) {
  df <- read_csv(fallback_file, show_col_types = FALSE)
  cat("**Data loaded from:** `", fallback_file, "`\n\n")
} else {
  stop("Could not find merged data file. Please run Metadata_Merge first.")
}

cat("**Total samples:**", nrow(df), "\n\n")
cat("**Total columns:**", ncol(df), "\n\n")

# Summarize counts by Run Ã— Bay using shared function
df_summary <- summarize_counts(df, "All_Samples") %>%
  arrange(Run, Bay)

knitr::kable(df_summary)
```

# B. Biomarkers
Examine the relationship of biomarker values in the dataset.

## B.1 Clustering
Cluster the biomarkers into smaller groups for ease of visualization.

```{r cluster-biomarkers, message=FALSE, warning=FALSE, echo=TRUE}
library(caret)
library(pheatmap)

# Define metadata columns (these are NOT biomarkers)
metadata_cols <- c("RUN", "SAMPLE_ALIQUOT", "SAMPLE", "Record_ID", "newsample",
                   "Group", "Ethnicity", "Race", "sex", "age_at_subject",
                   "CDX", "Case_Control", "AOO", "Years_Onset", "APOE.geno",
                   "height_inches", "weight_lb", "BMI", "Site", "Country/State",
                   "country_of_birth", "Group_Race_Ethnicity", "___1", "Run", "Bay",
                   "SampleID", "age_at_sample", "Race_Ethnicity", "Run_Bay", "APOE")

# Get biomarker columns (numeric columns that are not metadata)
biomarker_cols <- setdiff(names(df), metadata_cols)
biomarker_cols <- biomarker_cols[sapply(df[biomarker_cols], is.numeric)]

cat("**Number of biomarkers:**", length(biomarker_cols), "\n\n")

# Keep only biomarker columns for clustering
samp_num <- df[, biomarker_cols, drop = FALSE]

# Compute correlation matrix
cor_mat <- cor(samp_num, use = "pairwise.complete.obs")

# Heatmap of biomarker correlations
pheatmap(cor_mat,
         main = "Heatmap of Biomarkers",
         fontsize_row = 6, fontsize_col = 6)

# 1. Visual inspection with dendrogram
hc <- hclust(as.dist(1 - cor_mat))
plot(hc, cex = 0.5, main = "Biomarker Dendrogram")
rect.hclust(hc, k = 8, border = "red")  # Visualize 8 groups

# 2. Cut tree into groups
n_groups <- 8  # Adjust based on dendrogram
clusters <- cutree(hc, k = n_groups)

# 3. Create data frame for easy viewing
cluster_df <- data.frame(
  Biomarker = names(clusters),
  Group = clusters
) %>% arrange(Group)

# 4. Save groups as list
biomarker_groups <- split(cluster_df$Biomarker, cluster_df$Group)

# 5. Examine each group
for(i in seq_along(biomarker_groups)) {
  cat("\n=== Group", i, "===\n")
  cat("Size:", length(biomarker_groups[[i]]), "\n")
  print(biomarker_groups[[i]])
}

# 6. Save to file
write.csv(cluster_df, "output_files/biomarker_groups.csv", row.names = FALSE)

```

## B.2 Biomarker Groups

```{r heatmaps-plots--biomarkers, message=FALSE, warning=FALSE, echo=TRUE, results='asis', eval=TRUE}
# Use the shared plot_group_heatmaps function from shared_functions.R
plot_group_heatmaps(df, biomarker_groups, cor_mat,
                    show_numbers = FALSE,
                    min_group_size = 3,
                    fontsize = 8,
                    add_boxplots = TRUE)

```

# C. Meta-data
For each group, are covariates (sex, age, AD) associated with biomarkers (ignoring lod).
I'm curious to look at error above and below the lod. Also, how are these distributed across plates?

## C.1 Summary

```{r get_meta, message=FALSE, warning=FALSE, echo=TRUE, results='asis'}
library(dplyr)

# Data is already merged from Metadata_Merge - just use it directly
# Rename to meta_plus for compatibility with downstream code
meta_plus <- df

# Ensure SampleID column exists
if (!"SampleID" %in% names(meta_plus) && "SAMPLE_ALIQUOT" %in% names(meta_plus)) {
  meta_plus <- meta_plus %>% rename(SampleID = SAMPLE_ALIQUOT)
}

# Summarize metadata columns using shared function
meta_cols_to_summarize <- intersect(
  c("Race", "Ethnicity", "Group", "sex", "age_at_subject", "CDX", "BMI", "Site", "Country/State"),
  names(meta_plus)
)
summary_table <- summarize_df_pretty(meta_plus[, meta_cols_to_summarize, drop = FALSE])
knitr::kable(summary_table, caption = "Summary of Meta-data")

cat("\n\n**Categories to keep combining Race and Group: BL-AA, BL-AFDC, WH-HI, MU-HI (Exclude BL-HI for now because so few males.)**\n\n")

# Combine and filter Race_Ethnicity groups
meta_plus <- meta_plus %>%
  mutate(Race_Ethnicity = paste(Race, Group, sep = "_"))

meta_plus_race <- meta_plus %>%
  filter(Race_Ethnicity %in% c("BL_AA", "BL_AFDC", "WH_HI", "MU_HI")) %>%
  mutate(Race_Ethnicity = factor(Race_Ethnicity, levels = c("BL_AA", "BL_AFDC", "WH_HI", "MU_HI")))

meta_plus_race_dx <- meta_plus_race %>%
  filter(CDX %in% c("NCI", "MCI", "AD")) %>%
  mutate(CDX = factor(CDX, levels = c("NCI", "MCI", "AD")))

# Rename age column if needed
if ("age_at_subject" %in% names(meta_plus_race_dx) && !"age_at_sample" %in% names(meta_plus_race_dx)) {
  meta_plus_race_dx <- meta_plus_race_dx %>%
    rename(age_at_sample = age_at_subject)
}

summary_table <- meta_plus_race_dx %>%
  group_by(Race_Ethnicity, sex, CDX) %>%
  summarise(
    n = n(),
    Age_mean = mean(age_at_sample, na.rm = TRUE),
    Age_sd   = sd(age_at_sample, na.rm = TRUE),
    .groups = "drop"
  )
knitr::kable(summary_table)

# meta_plus has all data, meta_plus_race contains only samples with selected race_ethnicity
# and meta_plus_race_dx contains only those with valid dx.
# Export dataset for later use
write.csv(meta_plus_race_dx, "output_files/meta_plus_race_dx.csv", row.names = FALSE)
```


# D. Univariate Tests with Biomarkers
For each Group of biomarkers, test for association with covariates.

## D.1 Covariate Effects
```{r meta_assoc_covar, eval=TRUE, echo=TRUE, message=FALSE, warning=FALSE, results='asis'}
# Uses test_covariate_associations from shared_functions.R
# Libraries are loaded by the shared functions via require()

# Combine Run and Bay
meta_plus_race_dx <- meta_plus_race_dx %>%
  mutate(Run_Bay = paste(Run, Bay, sep = "_"))

# No AFDC
meta_plus_race_dx_noAFDC <- meta_plus_race_dx %>%
  filter(Group == "AA" | Group == "HI")

# Filter AA and AFDC
meta_plus_race_dx_bl <- meta_plus_race_dx %>%
  filter(Group == "AA" | Group == "AFDC")

meta_plus_race_dx_bl_nci <- meta_plus_race_dx_bl %>%
  filter(CDX == "NCI")

# Run association tests using shared function
cat("\n### *No AFDC or MU_HI, NCI only*\n\n")
results <- test_covariate_associations(
  data = meta_plus_race_dx_noAFDC %>%
    filter(CDX == "NCI") %>%
    filter(!Race == "MU"),
  biomarker_groups = biomarker_groups,
  covariates = c("Race_Ethnicity"),
  fdr_threshold = 0.01,
  biomarkers_to_test = NULL,
  print_tables = TRUE
)

# Export results if needed
# write.csv(results$omnibus, "output_files/covariate_associations.csv", row.names = FALSE)
```


## D.2 Plate Effects

```{r plate_assoc, eval=FALSE, echo=TRUE, message=FALSE, warning=FALSE, results='asis', fig.width=12, fig.height=12}
# Uses test_covariate_associations_specific from shared_functions.R

# Filter to specific runs for plate effect analysis
meta_filtered <- meta_plus_race_dx %>%
  filter(Run == "20251125-1332" | Run == "20250806-1118")

# Test all biomarkers for country effects
my_biomarkers <- unlist(biomarker_groups)

cat("\n## Country Effects\n\n")
cat("\n### Colored by Country/State\n\n")
results <- test_covariate_associations_specific(
  data = meta_filtered,
  biomarkers = my_biomarkers,
  covariates = c("Country/State"),
  color_by = "Country/State",
  max_plots_per_page = 1,
  fdr_threshold = 0.00001
)
            
            if (n_levels == 2) {
              # T-test for binary variables
              tb <- t.test(as.formula(formula_str), data = data_cov)
              
              # NEW: Get group means
              group_means <- data_cov %>%
                group_by(!!sym(cov)) %>%
                summarise(mean = mean(!!sym(.x), na.rm = TRUE), .groups = "drop")
              
              tibble(
                Biomarker = .x,
                statistic = tb$statistic,
                p.value = tb$p.value,
                method = "t-test",
                mean_diff = diff(group_means$mean),  # NEW
                group_info = paste(group_means[[cov]], "=", 
                                  round(group_means$mean, 3), collapse = "; ")  # NEW
              )
            } else {
              # ANOVA for 3+ levels
              lm_fit <- lm(as.formula(formula_str), data = data_cov)
              aov_result <- anova(lm_fit)
              
              # NEW: Get group means
              group_means <- data_cov %>%
                group_by(!!sym(cov)) %>%
                summarise(mean = mean(!!sym(.x), na.rm = TRUE), 
                         sd = sd(!!sym(.x), na.rm = TRUE),
                         .groups = "drop")
              
              tibble(
                Biomarker = .x,
                F_statistic = aov_result[1, "F value"],
                p.value = aov_result[1, "Pr(>F)"],
                method = "ANOVA",
                group_info = paste(group_means[[cov]], "=", 
                                  round(group_means$mean, 3), collapse = "; ")  # NEW
              )
            }
          }, error = function(e) {
            tibble(Biomarker = .x, statistic = NA, p.value = NA, 
                   method = "error", group_info = NA)
          })
        }
      )
      
      # NEW: Pairwise comparisons for significant ANOVA results
      if (n_levels > 2) {
        sig_biomarkers_anova <- results_cov %>%
          mutate(FDR_temp = p.adjust(p.value, method = "fdr")) %>%
          filter(FDR_temp < fdr_threshold) %>%
          pull(Biomarker)
        
        if (length(sig_biomarkers_anova) > 0) {
          pairwise_list <- map(sig_biomarkers_anova, ~ {
            protected_biomarker <- protect_name(.x)
            protected_cov <- protect_name(cov)
            formula_str <- paste(protected_biomarker, "~", protected_cov)
            
            pw <- pairwise.t.test(data_cov[[.x]], data_cov[[cov]], 
                                  p.adjust.method = "bonferroni")
            
            # Convert to tidy format
            pw_tidy <- as.data.frame(pw$p.value) %>%
              rownames_to_column("group1") %>%
              pivot_longer(-group1, names_to = "group2", values_to = "p.value") %>%
              filter(!is.na(p.value)) %>%
              mutate(Biomarker = .x)
            
            pw_tidy
          })
          
          pairwise_results[[cov]] <- bind_rows(pairwise_list)
        }
      }
      
    } else {
      # Continuous covariate - use linear regression
      results_cov <- map_df(
        biomarkers,
        ~ {
          tryCatch({
            protected_biomarker <- protect_name(.x)
            protected_cov <- protect_name(cov)
            formula_str <- paste(protected_biomarker, "~", protected_cov)
            
            lm_fit <- lm(as.formula(formula_str), data = data_cov)
            tidy(lm_fit) %>% 
              filter(term == cov | term == protected_cov) %>%
              mutate(Biomarker = .x, method = "Linear Regression") %>%
              select(Biomarker, estimate, statistic, p.value, method)
          }, error = function(e) {
            tibble(Biomarker = .x, estimate = NA, statistic = NA, 
                   p.value = NA, method = "error")
          })
        }
      )
    }
    
    # Add FDR correction
    results_cov <- results_cov %>%
      arrange(p.value) %>%
      mutate(FDR = p.adjust(p.value, method = "fdr"))
    
    # Store results
    all_results[[cov]] <- results_cov %>%
      mutate(Covariate = cov)
    
    # Display table
    if (is_categorical && n_levels == 2) {
      header_text <- paste("T-test for association with", cov)
      display_cols <- c("Biomarker", "statistic", "p.value", "FDR", "mean_diff")
    } else if (is_categorical) {
      header_text <- paste("ANOVA for association with", cov)
      display_cols <- c("Biomarker", "F_statistic", "p.value", "FDR")
    } else {
      header_text <- paste("Linear Regression for", cov, "association")
      display_cols <- c("Biomarker", "estimate", "statistic", "p.value", "FDR")
    }
    
    results_display <- results_cov %>% select(any_of(display_cols))
    
    print(
      results_display %>%
        kbl(format = "html", digits = 4) %>%
        add_header_above(setNames(ncol(results_display), header_text)) %>%
        kable_styling(
          bootstrap_options = c("striped", "hover", "condensed"),
          full_width = FALSE
        )
    )
    
    cat("\n\n")
    
    # NEW: Print pairwise comparisons for significant ANOVA results
    if (is_categorical && n_levels > 2 && cov %in% names(pairwise_results)) {
      cat("\n**Pairwise comparisons (Bonferroni-adjusted) for significant biomarkers:**\n\n")
      
      pw_display <- pairwise_results[[cov]] %>%
        arrange(Biomarker, p.value)
      
      print(
        pw_display %>%
          kbl(format = "html", digits = 4) %>%
          kable_styling(
            bootstrap_options = c("striped", "hover", "condensed"),
            full_width = FALSE
          )
      )
      
      cat("\n\n")
    }
    
    # Plots for significant associations
    sig_biomarkers <- results_cov %>% 
      filter(FDR < fdr_threshold) %>% 
      pull(Biomarker)
    
    if (length(sig_biomarkers) > 0) {
      cat("\n**Significant", cov, "Associations (FDR <", fdr_threshold, "):** ", 
          length(sig_biomarkers), "biomarkers\n\n")
      
      # Split into pages
      n_pages <- ceiling(length(sig_biomarkers) / max_plots_per_page)
      
      for (page in 1:n_pages) {
        start_idx <- (page - 1) * max_plots_per_page + 1
        end_idx <- min(page * max_plots_per_page, length(sig_biomarkers))
        page_biomarkers <- sig_biomarkers[start_idx:end_idx]
        
        if (n_pages > 1) {
          cat("\n*Page", page, "of", n_pages, "*\n\n")
        }
        
        if (is_categorical) {
          # Boxplots for categorical covariates
          select_cols <- c(cov, page_biomarkers)
          if (!is.null(color_by) && color_by %in% names(data_cov)) {
            select_cols <- c(select_cols, color_by)
          }
          
          plot_data <- data_cov %>%
            select(all_of(select_cols)) %>%
            pivot_longer(cols = all_of(page_biomarkers),
                         names_to = "Biomarker",
                         values_to = "Value")
          
          # Create base plot
          if (!is.null(color_by) && color_by %in% names(plot_data)) {
            if (is.character(plot_data[[color_by]])) {
              plot_data[[color_by]] <- factor(plot_data[[color_by]])
            }
            
            p <- ggplot(plot_data, aes(y = .data[[cov]], x = Value, fill = .data[[color_by]])) +
              geom_boxplot(alpha = 0.7, outlier.shape = 16, outlier.size = 1, 
                          position = position_dodge(0.8)) +
              geom_point(aes(color = .data[[color_by]]), 
                        position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8),
                        alpha = 0.4, size = 1) +
              labs(fill = color_by, color = color_by)
          } else {
            p <- ggplot(plot_data, aes(x = .data[[cov]], y = Value, fill = .data[[cov]])) +
              geom_boxplot(alpha = 0.7, outlier.shape = 16, outlier.size = 1) +
              geom_jitter(width = 0.2, alpha = 0.3, size = 1)
          }
          
          p <- p +
            facet_wrap(~ Biomarker, scales = "free_y", ncol = 3) +
            theme_minimal() +
            theme(
              strip.text = element_text(face = "bold", size = 9),
              axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
              legend.position = "bottom"
            ) +
            labs(
              title = paste(cov, "Associations (FDR <", fdr_threshold, ")"),
              x = cov,
              y = "Biomarker Value"
            )
          
          if (is.null(color_by) || color_by == cov) {
            if (cov == "sex" && all(levels(data_cov[[cov]]) %in% c("F", "M"))) {
              p <- p + scale_fill_manual(values = c("F" = "#E69F00", "M" = "#56B4E9"))
            } else if (cov == "CDX_grouped") {
              p <- p + scale_fill_manual(
                values = c("NCI" = "#2ECC71", "MCI" = "#F39C12", "AD" = "#E74C3C")
              )
            }
          }
          
          print(p)
          cat("\n\n")
          
        } else {
          # Histograms for continuous covariates
          plots <- lapply(page_biomarkers, function(biom) {
            select_cols <- c(cov, biom)
            if (!is.null(color_by) && color_by %in% names(data_cov)) {
              select_cols <- c(select_cols, color_by)
            }
            
            plot_data <- data_cov %>%
              select(all_of(select_cols))
            
            names(plot_data)[names(plot_data) == cov] <- "x_var"
            names(plot_data)[names(plot_data) == biom] <- "y_var"
            
            fdr_val <- results_cov %>% 
              filter(Biomarker == biom) %>% 
              pull(FDR)
            
            if (!is.null(color_by) && color_by %in% names(plot_data)) {
              if (is.character(plot_data[[color_by]])) {
                plot_data[[color_by]] <- factor(plot_data[[color_by]])
              }
              
              p <- ggplot(plot_data, aes(x = y_var, fill = .data[[color_by]])) +
                geom_histogram(alpha = 0.6, position = "identity", bins = 30) +
                labs(fill = color_by)
              
              if (color_by == "sex") {
                p <- p + scale_fill_manual(values = c("F" = "#E69F00", "M" = "#56B4E9"))
              } else if (color_by == "CDX_grouped") {
                p <- p + scale_fill_manual(
                  values = c("NCI" = "#2ECC71", "MCI" = "#F39C12", "AD" = "#E74C3C")
                )
              }
            } else {
              p <- ggplot(plot_data, aes(x = y_var)) +
                geom_histogram(fill = "steelblue", alpha = 0.7, bins = 30)
            }
            
            p <- p +
              theme_minimal() +
              labs(
                title = biom,
                subtitle = paste0("Association with ", cov, 
                                ", FDR = ", format(fdr_val, digits = 3, scientific = TRUE)),
                x = "Biomarker Value",
                y = "Count"
              ) +
              theme(
                plot.title = element_text(face = "bold", size = 9),
                plot.subtitle = element_text(size = 7),
                axis.title = element_text(size = 8),
                axis.text = element_text(size = 7),
                legend.position = "bottom",
                legend.title = element_text(size = 7),
                legend.text = element_text(size = 6)
              )
            
            return(p)
          })
          
          n_cols <- min(3, length(plots))
          do.call(grid.arrange, c(plots, ncol = n_cols, 
                                 top = paste(cov, "Associations (FDR <", 
                                           fdr_threshold, ") - Page", page)))
          cat("\n\n")
        }
      }
    } else {
      cat("\n*No significant", cov, "associations at FDR <", fdr_threshold, "*\n\n")
    }
    
    cat("\n---\n\n")
  }
  
  # Combine all results
  if (length(all_results) > 0) {
    combined_results <- bind_rows(all_results)
    return(invisible(list(
      omnibus = combined_results,
      pairwise = if(length(pairwise_results) > 0) bind_rows(pairwise_results, .id = "Covariate") else NULL
    )))
  } else {
    return(invisible(NULL))
  }
}
# # Function to test biomarker associations with specified covariates
# test_covariate_associations_specific <- function(meta_plus, 
#                                        biomarkers = NULL,
#                                        covariates = c("sex", "age_at_sample"),
#                                        color_by = NULL,
#                                        fdr_threshold = 0.05,
#                                        max_plots_per_page = 6) {
#   
#   # Helper function to protect variable names
#   protect_name <- function(name) {
#     if (grepl("[^a-zA-Z0-9_.]", name)) {
#       return(paste0("`", name, "`"))
#     }
#     return(name)
#   }
#   
#   # Check if biomarkers exist in data
#   missing_biomarkers <- setdiff(biomarkers, names(meta_plus))
#   if (length(missing_biomarkers) > 0) {
#     warning("The following biomarkers not found in data: ", 
#             paste(missing_biomarkers, collapse = ", "))
#     biomarkers <- intersect(biomarkers, names(meta_plus))
#   }
#   
#   if (length(biomarkers) == 0) {
#     stop("No valid biomarkers specified")
#   }
#   
#   # Select necessary columns
#   essential_cols <- unique(c("SampleID", covariates, color_by, biomarkers))
#   data_subset <- meta_plus %>% 
#     select(all_of(essential_cols))
#   
#   # Initialize results storage
#   all_results <- list()
#   
#   # Loop through each covariate
#   for (cov in covariates) {
#     cat("\n### Association with", cov, "\n\n")
#     
#     # Check if covariate exists
#     if (!cov %in% names(data_subset)) {
#       cat("*Skipping", cov, "- column not found in data*\n\n")
#       next
#     }
#     
#     # Filter for complete cases on this covariate
#     data_cov <- data_subset %>%
#       filter(!is.na(!!sym(cov)))
#     
#     # Check if we have any data left
#     if (nrow(data_cov) == 0) {
#       cat("*Skipping", cov, "- no complete cases*\n\n")
#       next
#     }
#     
#     # Convert to factor if character
#     if (is.character(data_cov[[cov]])) {
#       data_cov[[cov]] <- factor(data_cov[[cov]])
#     }
#     
#     # Determine test type based on covariate type
#     is_categorical <- is.factor(data_cov[[cov]]) || 
#                      is.character(data_cov[[cov]])
#     
#     if (is_categorical) {
#       # Categorical covariate - use ANOVA or t-test
#       n_levels <- length(unique(data_cov[[cov]]))
#       
#       if (n_levels < 2) {
#         cat("*Skipping", cov, "- only", n_levels, "level(s)*\n\n")
#         next
#       }
#       
#       # Run tests
#       results_cov <- map_df(
#         biomarkers,
#         ~ {
#           tryCatch({
#             protected_biomarker <- protect_name(.x)
#             protected_cov <- protect_name(cov)
#             formula_str <- paste(protected_biomarker, "~", protected_cov)
#             
#             if (n_levels == 2) {
#               # T-test for binary variables
#               tb <- t.test(as.formula(formula_str), data = data_cov)
#               tibble(
#                 Biomarker = .x,
#                 statistic = tb$statistic,
#                 p.value = tb$p.value,
#                 method = "t-test"
#               )
#             } else {
#               # ANOVA for 3+ levels
#               lm_fit <- lm(as.formula(formula_str), data = data_cov)
#               aov_result <- anova(lm_fit)
#               tibble(
#                 Biomarker = .x,
#                 F_statistic = aov_result[1, "F value"],
#                 p.value = aov_result[1, "Pr(>F)"],
#                 method = "ANOVA"
#               )
#             }
#           }, error = function(e) {
#             tibble(Biomarker = .x, statistic = NA, p.value = NA, method = "error")
#           })
#         }
#       )
#       
#     } else {
#       # Continuous covariate - use linear regression
#       results_cov <- map_df(
#         biomarkers,
#         ~ {
#           tryCatch({
#             protected_biomarker <- protect_name(.x)
#             protected_cov <- protect_name(cov)
#             formula_str <- paste(protected_biomarker, "~", protected_cov)
#             
#             lm_fit <- lm(as.formula(formula_str), data = data_cov)
#             tidy(lm_fit) %>% 
#               filter(term == cov | term == protected_cov) %>%
#               mutate(Biomarker = .x, method = "Linear Regression") %>%
#               select(Biomarker, estimate, statistic, p.value, method)
#           }, error = function(e) {
#             tibble(Biomarker = .x, estimate = NA, statistic = NA, 
#                    p.value = NA, method = "error")
#           })
#         }
#       )
#     }
#     
#     # Add FDR correction
#     results_cov <- results_cov %>%
#       arrange(p.value) %>%
#       mutate(FDR = p.adjust(p.value, method = "fdr"))
#     
#     # Store results
#     all_results[[cov]] <- results_cov %>%
#       mutate(Covariate = cov)
#     
#     # Display table
#     if (is_categorical && n_levels == 2) {
#       header_text <- paste("T-test for association with", cov)
#       display_cols <- c("Biomarker", "statistic", "p.value", "FDR")
#     } else if (is_categorical) {
#       header_text <- paste("ANOVA for association with", cov)
#       display_cols <- c("Biomarker", "F_statistic", "p.value", "FDR")
#     } else {
#       header_text <- paste("Linear Regression for", cov, "association")
#       display_cols <- c("Biomarker", "estimate", "statistic", "p.value", "FDR")
#     }
#     
#     results_display <- results_cov %>% select(any_of(display_cols))
#     
#     print(
#       results_display %>%
#         kbl(format = "html", digits = 4) %>%
#         add_header_above(setNames(ncol(results_display), header_text)) %>%
#         kable_styling(
#           bootstrap_options = c("striped", "hover", "condensed"),
#           full_width = FALSE
#         )
#     )
#     
#     cat("\n\n")
#     
#     # Plots for significant associations
#     sig_biomarkers <- results_cov %>% 
#       filter(FDR < fdr_threshold) %>% 
#       pull(Biomarker)
#     
#     if (length(sig_biomarkers) > 0) {
#       cat("\n**Significant", cov, "Associations (FDR <", fdr_threshold, "):** ", 
#           length(sig_biomarkers), "biomarkers\n\n")
#       
#       # Split into pages
#       n_pages <- ceiling(length(sig_biomarkers) / max_plots_per_page)
#       
#       for (page in 1:n_pages) {
#         start_idx <- (page - 1) * max_plots_per_page + 1
#         end_idx <- min(page * max_plots_per_page, length(sig_biomarkers))
#         page_biomarkers <- sig_biomarkers[start_idx:end_idx]
#         
#         if (n_pages > 1) {
#           cat("\n*Page", page, "of", n_pages, "*\n\n")
#         }
#         
#         if (is_categorical) {
#           # Boxplots for categorical covariates (vertical orientation)
#           select_cols <- c(cov, page_biomarkers)
#           if (!is.null(color_by) && color_by %in% names(data_cov)) {
#             select_cols <- c(select_cols, color_by)
#           }
#           
#           plot_data <- data_cov %>%
#             select(all_of(select_cols)) %>%
#             pivot_longer(cols = all_of(page_biomarkers),
#                          names_to = "Biomarker",
#                          values_to = "Value")
#           
#           # Create base plot
#           if (!is.null(color_by) && color_by %in% names(plot_data)) {
#             # Color by specified variable
#             if (is.character(plot_data[[color_by]])) {
#               plot_data[[color_by]] <- factor(plot_data[[color_by]])
#             }
#             
#             p <- ggplot(plot_data, aes(y = .data[[cov]], x = Value, fill = .data[[color_by]])) +
#               geom_boxplot(alpha = 0.7, outlier.shape = 16, outlier.size = 1, 
#                           position = position_dodge(0.8)) +
#               geom_point(aes(color = .data[[color_by]]), 
#                         position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8),
#                         alpha = 0.4, size = 1) +
#               labs(fill = color_by, color = color_by)
#           } else {
#             # Color by covariate itself
#             p <- ggplot(plot_data, aes(x = .data[[cov]], y = Value, fill = .data[[cov]])) +
#               geom_boxplot(alpha = 0.7, outlier.shape = 16, outlier.size = 1) +
#               geom_jitter(width = 0.2, alpha = 0.3, size = 1)
#           }
#           
#           p <- p +
#             facet_wrap(~ Biomarker, scales = "free_y", ncol = 3) +
#             theme_minimal() +
#             theme(
#               strip.text = element_text(face = "bold", size = 9),
#               axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
#               legend.position = "bottom"
#             ) +
#             labs(
#               title = paste(cov, "Associations (FDR <", fdr_threshold, ")"),
#               x = cov,
#               y = "Biomarker Value"
#             )
#           
#           # Add custom colors for common covariates
#           if (is.null(color_by) || color_by == cov) {
#             if (cov == "sex" && all(levels(data_cov[[cov]]) %in% c("F", "M"))) {
#               p <- p + scale_fill_manual(values = c("F" = "#E69F00", "M" = "#56B4E9"))
#             } else if (cov == "CDX_grouped") {
#               p <- p + scale_fill_manual(
#                 values = c("NCI" = "#2ECC71", "MCI" = "#F39C12", "AD" = "#E74C3C")
#               )
#             }
#           }
#           
#           print(p)
#           cat("\n\n")
#           
#         } else {
#           # Histograms for continuous covariates (vertical orientation)
#           plots <- lapply(page_biomarkers, function(biom) {
#             select_cols <- c(cov, biom)
#             if (!is.null(color_by) && color_by %in% names(data_cov)) {
#               select_cols <- c(select_cols, color_by)
#             }
#             
#             plot_data <- data_cov %>%
#               select(all_of(select_cols))
#             
#             names(plot_data)[names(plot_data) == cov] <- "x_var"
#             names(plot_data)[names(plot_data) == biom] <- "y_var"
#             
#             fdr_val <- results_cov %>% 
#               filter(Biomarker == biom) %>% 
#               pull(FDR)
#             
#             # Create base plot with vertical orientation
#             if (!is.null(color_by) && color_by %in% names(plot_data)) {
#               if (is.character(plot_data[[color_by]])) {
#                 plot_data[[color_by]] <- factor(plot_data[[color_by]])
#               }
#               
#               p <- ggplot(plot_data, aes(x = y_var, fill = .data[[color_by]])) +
#                 geom_histogram(alpha = 0.6, position = "identity", bins = 30) +
#                 labs(fill = color_by)
#               
#               # Add custom colors for common variables
#               if (color_by == "sex") {
#                 p <- p + scale_fill_manual(values = c("F" = "#E69F00", "M" = "#56B4E9"))
#               } else if (color_by == "CDX_grouped") {
#                 p <- p + scale_fill_manual(
#                   values = c("NCI" = "#2ECC71", "MCI" = "#F39C12", "AD" = "#E74C3C")
#                 )
#               }
#             } else {
#               p <- ggplot(plot_data, aes(x = y_var)) +
#                 geom_histogram(fill = "steelblue", alpha = 0.7, bins = 30)
#             }
#             
#             p <- p +
#               theme_minimal() +
#               labs(
#                 title = biom,
#                 subtitle = paste0("Association with ", cov, 
#                                 ", FDR = ", format(fdr_val, digits = 3, scientific = TRUE)),
#                 x = "Biomarker Value",
#                 y = "Count"
#               ) +
#               theme(
#                 plot.title = element_text(face = "bold", size = 9),
#                 plot.subtitle = element_text(size = 7),
#                 axis.title = element_text(size = 8),
#                 axis.text = element_text(size = 7),
#                 legend.position = "bottom",
#                 legend.title = element_text(size = 7),
#                 legend.text = element_text(size = 6)
#               )
#             
#             return(p)
#           })
#           
#           n_cols <- min(3, length(plots))
#           do.call(grid.arrange, c(plots, ncol = n_cols, 
#                                  top = paste(cov, "Associations (FDR <", 
#                                            fdr_threshold, ") - Page", page)))
#           cat("\n\n")
#         }
#       }
#     } else {
#       cat("\n*No significant", cov, "associations at FDR <", fdr_threshold, "*\n\n")
#     }
#     
#     cat("\n---\n\n")
#   }
#   
#   # Combine all results
#   if (length(all_results) > 0) {
#     combined_results <- bind_rows(all_results)
#     return(invisible(combined_results))
#   } else {
#     return(invisible(NULL))
#   }
# }



# Removing PLATES WITH FEW VALUES, 20251002-1810-Bay2 and 20251124-1407-Bay2
# meta_filtered <- meta_plus_race_dx %>%
#   filter(
#     !(Run == "20251002-1810" & Bay == "Bay2"),
#     !(Run == "20251124-1407" & Bay == "Bay2")
#   )


meta_filtered <- meta_plus_race_dx %>%
  filter(
    (Run == "20251125-1332" | Run == "20250806-1118")
  )
#my_biomarkers=sig_with_run$Biomarker
#my_biomarkers=c("ANXA5", "PARK7", "NRGN", "BD-pTau-181", "TARDBP", "ARSA", "SOD1")
#my_biomarkers=c(biomarker_groups[[8]], biomarker_groups[[5]])

#cat("\n#### Colored by Race_Ethnicity \n\n")
# results <- test_covariate_associations_specific(
#   meta_plus_race_dx, 
#   biomarkers=my_biomarkers,
#   covariates = c("Run_Bay"),
#   color_by = "Race_Ethnicity",
#   max_plots_per_page=1,
#   fdr_threshold =0.05
# )  
# results <- test_covariate_associations_specific(
#   meta_filtered, 
#   biomarkers=my_biomarkers,
#   covariates = c("Run_Bay"),
#   color_by = "Race_Ethnicity",
#   max_plots_per_page=1,
#   fdr_threshold =0.05
# )  

# my_biomarkers=c("PARK7", "ENO2", "PGF")
# cat("\n## Bay Effects \n\n")
# cat("\n### Colored by Bay \n\n")
# results <- test_covariate_associations_specific(
#   meta_filtered,
#   biomarkers=my_biomarkers,
#   covariates = c("Run_Bay"),
#   color_by = "Bay",
#   max_plots_per_page=1,
#   fdr_threshold =0.00001
# )
# results <- test_covariate_associations_specific(
#   meta_filtered,
#   biomarkers=my_biomarkers,
#   covariates = c("Run_Bay"),
#   color_by = "Country/State",
#   max_plots_per_page=1,
#   fdr_threshold =0.00001
# )
# cat("\n### Colored by CDX \n\n")
# results <- test_covariate_associations_specific(
#   meta_filtered,
#   biomarkers=my_biomarkers,
#   covariates = c("Run_Bay"),
#   color_by = "CDX",
#   max_plots_per_page=1,
#   fdr_threshold =0.00001
# )

my_biomarkers= unlist(biomarker_groups)
cat("\n## Country Effects \n\n")
cat("\n### Colored by Country/State \n\n")
results <- test_covariate_associations_specific(
  meta_filtered, 
  biomarkers=my_biomarkers,
  covariates = c("Country/State"),
  color_by = "Country/State",
  max_plots_per_page=1,
  fdr_threshold =0.00001
)  
# cat("\n### Colored by Bay \n\n")
# results <- test_covariate_associations_specific(
#   meta_filtered, 
#   biomarkers=my_biomarkers,
#   covariates = c("Country/State"),
#   color_by = "Bay",
#   max_plots_per_page=1,
#   fdr_threshold =0.00001
# )  
# cat("\n### Colored by CDX \n\n")
# results <- test_covariate_associations_specific(
#   meta_filtered, 
#   biomarkers=my_biomarkers,
#   covariates = c("Country/State"),
#   color_by = "CDX",
#   max_plots_per_page=1,
#   fdr_threshold =0.00001
# )  

```

# E. Notes
* Park7 has notable Bay effects. Look at replicates.
* Are there Run/Bay effects that we can adjust away?
* There are differences among the African countries. Often all three are different. Seems as Tanzania is most different, but it depends on the biomarker Group.
* Throw in some AA plates with my Africans
* Try NCI only
* ANXA5 has an M2 haplotype which is less common in AA and reduces expression. Could it be common in Tanzania?