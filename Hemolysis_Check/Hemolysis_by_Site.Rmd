---
title: "Hemolysis Analysis by Site"
author: "ERM"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    code_folding: hide
---

# Overview

This is an analysis designed to examine five biomarkers that may be indicators of hemolysis in the samples prior to running the assay.

- HBA1 (Hemoglobin Subunit Alpha 1): The primary component of RBCs. Its presence in plasma is the direct gold-standard indicator of hemolysis.
- PGK1 (Phosphoglycerate Kinase 1): A glycolytic enzyme. Deficiency in this enzyme causes hereditary hemolytic anemia, emphasizing its critical role within RBCs.
- MDH1 (Malate Dehydrogenase 1): An enzyme involved in the citric acid cycle. It is often released during cell damage, particularly from RBCs.
- SOD1 (Superoxide Dismutase 1): An antioxidant enzyme highly abundant in the RBC cytoplasm.
- ENO2 (Enolase 2 / Neuron-Specific Enolase): While also found in neurons, it is present in RBCs and is frequently used as a marker for hemolysis interference in clinical labs.

# Setup

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(broom)
library(car)
library(corrplot)
library(knitr)
library(kableExtra)

# Load data - check input_files first, then fall back to Metadata_Merge output
input_file <- "input_files/filtered_combined_post_QC.csv"
fallback_file <- "../Metadata_Merge/output_files/filtered/filtered_combined_post_QC.csv"

if (file.exists(input_file)) {
  df <- read_csv(input_file, show_col_types = FALSE)
  cat("Loaded data from:", input_file, "\n")
} else if (file.exists(fallback_file)) {
  df <- read_csv(fallback_file, show_col_types = FALSE)
  cat("Loaded data from fallback:", fallback_file, "\n")
} else {
  stop("Could not find filtered_combined_post_QC.csv in input_files/ or Metadata_Merge/output_files/filtered/")
}

# Hemolysis markers - intracellular proteins that indicate RBC lysis
hemolysis_markers <- c("PGK1", "MDH1", "SOD1", "ENO2", "HBA1")

# Check which are available
hemolysis_available <- intersect(hemolysis_markers, names(df))
cat("Available hemolysis markers:", paste(hemolysis_available, collapse=", "), "\n")

# Define metadata columns (non-biomarker columns)
metadata_cols <- c("RUN", "SAMPLE_ALIQUOT", "SAMPLE", "Record_ID", "newsample",
                   "Group", "Ethnicity", "Race", "sex", "age_at_subject",
                   "CDX", "Case_Control", "AOO", "Years_Onset", "APOE.geno",
                   "height_inches", "weight_lb", "BMI", "Site", "Country/State",
                   "country_of_birth", "Group_Race_Ethnicity", "___1", "Run", "Bay")

# Get all biomarker columns (everything not in metadata)
biomarker_cols <- setdiff(names(df), metadata_cols)
cat("\nTotal biomarkers:", length(biomarker_cols), "\n")

# Helper function
protect_name <- function(name) {
  if (grepl("[^a-zA-Z0-9_.]", name)) {
    return(paste0("`", name, "`"))
  }
  return(name)
}
```

# 1. Create Hemolysis Index

We use the mean of available hemolysis markers.

```{r hemolysis-index, results='asis'}
# Create composite hemolysis index (mean of available markers)
df_hemo <- df %>%
  mutate(
    Hemolysis_Index = rowMeans(select(., all_of(hemolysis_available)), na.rm = TRUE),
    Site = factor(Site)
  ) %>%
  filter(!is.na(Hemolysis_Index))

# Save output with metadata + hemolysis markers + index
df_hemo %>%
  as_tibble() %>%
  select(all_of(intersect(metadata_cols, names(.))),
         all_of(hemolysis_available),
         Hemolysis_Index) %>%
  write_csv("output_files/hemo_data_output.csv")

cat("Sample size with hemolysis data:", nrow(df_hemo), "\n\n")
# Sample sizes by Site
cat("Sample sizes by Site:\n\n")
site_counts <- df_hemo %>% count(Site, sort = TRUE)
kable(site_counts)

# Collapse Sites with small sample sizes
min_site_n <- 5  # default threshold

df_hemo <- df_hemo %>%
  add_count(Site, name = "site_n") %>%
  mutate(
    Site = if_else(site_n <= min_site_n, "Other", as.character(Site)),
    Site = factor(Site)
  ) %>%
  select(-site_n)
site_counts <- df_hemo %>% count(Site, sort = TRUE)

```

# 2. Test Hemolysis by Site

## 2.1 Overall ANOVA

```{r hemolysis-by-site-anova, results='asis'}
# Test if hemolysis index differs by Site
lm_hemo <- lm(Hemolysis_Index ~ Site, data = df_hemo)
anova_hemo <- Anova(lm_hemo, type = "II")

cat("ANOVA: Hemolysis_Index ~ Site\n\n")
kable(tidy(anova_hemo), digits = 4)

if (anova_hemo$`Pr(>F)`[1] < 0.05) {
  cat("\n**Significant Site effect (p < 0.05)**\n")
  cat("Hemolysis varies across Sites - pre-analytical differences likely\n\n")
} else {
  cat("\n**No significant Site effect**\n")
  cat("Hemolysis appears consistent across Sites\n\n")
}
```

## 2.2 Mean Hemolysis by Site

```{r hemolysis-means, results='asis'}
hemo_by_site <- df_hemo %>%
  group_by(Site) %>%
  summarise(
    N = n(),
    Mean_Hemolysis = mean(Hemolysis_Index, na.rm = TRUE),
    SD = sd(Hemolysis_Index, na.rm = TRUE),
    Median = median(Hemolysis_Index, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  arrange(desc(Mean_Hemolysis))

cat("Hemolysis Index by Site (sorted high to low):\n\n")
kable(hemo_by_site, digits = 3)
```

## 2.3 Visualization

```{r hemolysis-plot, fig.width=10, fig.height=6}
ggplot(df_hemo, aes(x = reorder(Site, Hemolysis_Index, median), 
                    y = Hemolysis_Index, fill = Site)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.2, size = 0.8) +
  coord_flip() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(title = "Hemolysis Index by Site",
       subtitle = "Sites ordered by median hemolysis level",
       x = "Site", y = "Hemolysis Index (mean of 5 markers)")
```

# 3. Individual Hemolysis Markers by Site

```{r individual-markers, results='asis'}
# Test each hemolysis marker separately
marker_results <- map_df(hemolysis_available, function(marker) {
  
  formula_str <- paste(protect_name(marker), "~ Site")
  model_data <- df_hemo %>% 
    select(Site, all_of(marker)) %>% 
    drop_na()
  
  lm_fit <- lm(as.formula(formula_str), data = model_data)
  anova_result <- Anova(lm_fit, type = "II")
  
  # Get highest and lowest sites
  site_means <- model_data %>%
    group_by(Site) %>%
    summarise(Mean = mean(.data[[marker]]), .groups = "drop") %>%
    arrange(desc(Mean))
  
  tibble(
    Marker = marker,
    F_stat = anova_result$`F value`[1],
    p_value = anova_result$`Pr(>F)`[1],
    Highest_Site = site_means$Site[1],
    Lowest_Site = site_means$Site[nrow(site_means)],
    Fold_Difference = site_means$Mean[1] / site_means$Mean[nrow(site_means)]
  )
})

cat("Individual hemolysis markers by Site:\n\n")
marker_results %>%
  arrange(p_value) %>%
  kbl(digits = 3, format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

cat("\n\n**Interpretation:**\n")
cat("- p < 0.05: Marker varies significantly by Site\n")
cat("- Fold_Difference: How much higher the highest Site is vs lowest\n")
```

## 3.1 Heatmap of Markers by Site

```{r heatmap-markers, fig.width=10, fig.height=8}
# Create matrix of mean marker levels by Site
hemo_matrix <- df_hemo %>%
  select(Site, all_of(hemolysis_available)) %>%
  pivot_longer(cols = all_of(hemolysis_available), 
               names_to = "Marker", 
               values_to = "Value") %>%
  group_by(Site, Marker) %>%
  summarise(Mean = mean(Value, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = Site, values_from = Mean) %>%
  column_to_rownames("Marker") %>%
  as.matrix()

# Z-score normalize for visualization
hemo_matrix_z <- t(scale(t(hemo_matrix)))

# Heatmap
library(pheatmap)
pheatmap(hemo_matrix_z,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         color = colorRampPalette(c("blue", "white", "red"))(100),
         main = "Hemolysis Markers by Site (Z-scored)",
         fontsize = 8,
         cellwidth = 20,
         cellheight = 20)
```

# 4. Hemolysis Correlations by Site

```{r correlations-by-site, results='asis'}
cat("Test if hemolysis markers correlate within each Site\n")
cat("High correlations = coordinated hemolysis (sample handling issue)\n")
cat("Low correlations = independent variation\n\n")

# Get sites with sufficient sample size
sites_with_data <- site_counts %>% 
  filter(n >= 20) %>% 
  pull(Site)

cor_summary <- map_df(sites_with_data, function(site) {
  
  site_data <- df_hemo %>%
    filter(Site == site) %>%
    select(all_of(hemolysis_available)) %>%
    drop_na()
  
  if (nrow(site_data) >= 20) {
    cor_mat <- cor(site_data)
    upper_tri <- cor_mat[upper.tri(cor_mat)]
    
    tibble(
      Site = site,
      N = nrow(site_data),
      Mean_r = mean(upper_tri),
      Min_r = min(upper_tri),
      Max_r = max(upper_tri),
      SD_r = sd(upper_tri)
    )
  } else {
    tibble(
      Site = site,
      N = nrow(site_data),
      Mean_r = NA_real_,
      Min_r = NA_real_,
      Max_r = NA_real_,
      SD_r = NA_real_
    )
  }
})

cat("Hemolysis marker inter-correlations by Site:\n\n")
cor_summary %>%
  arrange(desc(Mean_r)) %>%
  kbl(digits = 3, format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

cat("\n\n**Interpretation:**\n")
cat("- Mean_r > 0.5: Strong coordinated hemolysis at that Site\n")
cat("- Mean_r < 0.3: Markers vary independently\n")
cat("- High SD_r: Inconsistent marker relationships\n")
```

# 5. Do Site Differences Reflect Hemolysis?

```{r site-hemolysis-confounding, results='asis'}
cat("Test if biomarkers with Site differences are confounded by hemolysis\n\n")

# First find biomarkers that differ by Site
biomarkers_with_site_effect <- map_df(biomarker_cols, function(biom) {
  
  formula_str <- paste(protect_name(biom), "~ Site")
  model_data <- df_hemo %>% 
    select(Site, all_of(biom)) %>% 
    drop_na()
  
  if (nrow(model_data) > 50) {
    lm_fit <- lm(as.formula(formula_str), data = model_data)
    anova_result <- Anova(lm_fit, type = "II")
    
    tibble(
      Biomarker = biom,
      F_Site = anova_result$`F value`[1],
      p_Site = anova_result$`Pr(>F)`[1]
    )
  } else {
    tibble(
      Biomarker = biom,
      F_Site = NA_real_,
      p_Site = NA_real_
    )
  }
}) %>%
  mutate(FDR_Site = p.adjust(p_Site, method = "fdr")) %>%
  filter(FDR_Site < 0.05) %>%
  arrange(p_Site)

cat("Biomarkers with significant Site effect (FDR < 0.05):", nrow(biomarkers_with_site_effect), "\n\n")

if (nrow(biomarkers_with_site_effect) > 0) {
  cat("Top 10:\n\n")
  kable(head(biomarkers_with_site_effect, 10), digits = 4)
  
  # Test if controlling for hemolysis reduces Site effect
  cat("\n\n## 5.1 Control for Hemolysis\n\n")
  
  hemolysis_control <- map_df(head(biomarkers_with_site_effect$Biomarker, 20), function(biom) {
    
    # Model without hemolysis
    formula1 <- as.formula(paste(protect_name(biom), "~ Site"))
    
    # Model with hemolysis
    formula2 <- as.formula(paste(protect_name(biom), "~ Site + Hemolysis_Index"))
    
    model_data <- df_hemo %>%
      select(Site, Hemolysis_Index, all_of(biom)) %>%
      drop_na()
    
    lm1 <- lm(formula1, data = model_data)
    lm2 <- lm(formula2, data = model_data)
    
    anova1 <- Anova(lm1, type = "II")
    anova2 <- Anova(lm2, type = "II")
    
    tibble(
      Biomarker = biom,
      F_Site_unadj = anova1$`F value`[1],
      p_Site_unadj = anova1$`Pr(>F)`[1],
      F_Site_adj = anova2$`F value`[1],
      p_Site_adj = anova2$`Pr(>F)`[1],
      F_Hemolysis = anova2$`F value`[2],
      p_Hemolysis = anova2$`Pr(>F)`[2],
      Pct_F_Reduction = 100 * (1 - anova2$`F value`[1] / anova1$`F value`[1])
    )
  })
  
  cat("Effect of controlling for hemolysis on Site differences:\n\n")
  hemolysis_control %>%
    arrange(desc(Pct_F_Reduction)) %>%
    kbl(digits = 3, format = "html") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
  
  cat("\n\n**Interpretation:**\n")
  cat("- Pct_F_Reduction > 50%: Site difference largely explained by hemolysis (artifact)\n")
  cat("- Pct_F_Reduction < 25%: Site difference persists (likely biological)\n")
  cat("- p_Hemolysis < 0.05: Biomarker associated with hemolysis\n\n")
  
  # Flag likely artifacts
  likely_artifacts <- hemolysis_control %>%
    filter(Pct_F_Reduction > 50, p_Site_unadj < 0.05)
  
  if (nrow(likely_artifacts) > 0) {
    cat("\n**Biomarkers likely affected by hemolysis artifact:**\n\n")
    kable(likely_artifacts %>% select(Biomarker, Pct_F_Reduction, p_Hemolysis))
  }
  
} else {
  cat("No biomarkers show significant Site differences\n")
}
```

# 6. Site × Hemolysis Interactions

```{r site-hemolysis-interaction, results='asis'}
cat("Test if hemolysis effects vary by Site\n")
cat("Significant interaction = hemolysis confounding differs across Sites\n\n")

# Test for top biomarkers with Site effect
if (exists("biomarkers_with_site_effect") &&
    nrow(biomarkers_with_site_effect) > 0) {

  # Required for Type III ANOVA
  options(contrasts = c("contr.sum", "contr.poly"))

  ## -----------------------------
  ## Interaction models
  ## -----------------------------
  interaction_results <- map_df(
    head(biomarkers_with_site_effect$Biomarker, 15),
    function(biom) {

      model_data <- df_hemo %>%
        select(Site, Hemolysis_Index, all_of(biom)) %>%
        drop_na() %>%
        mutate(Site = droplevels(factor(Site)))

      # Must have >1 Site and variation in Hemolysis
      if (nlevels(model_data$Site) < 2 ||
          sd(model_data$Hemolysis_Index) == 0) {
        return(NULL)
      }

      formula_int <- as.formula(
        paste(protect_name(biom), "~ Site * Hemolysis_Index")
      )

      lm_int <- try(lm(formula_int, data = model_data), silent = TRUE)
      if (inherits(lm_int, "try-error")) return(NULL)

      # Skip aliased models
      if (any(is.na(coef(lm_int)))) return(NULL)

      anova_int <- try(Anova(lm_int, type = "III"), silent = TRUE)
      if (inherits(anova_int, "try-error")) return(NULL)

      tibble(
        Biomarker = biom,
        F_Site = anova_int["Site", "F value"],
        p_Site = anova_int["Site", "Pr(>F)"],
        F_Hemolysis = anova_int["Hemolysis_Index", "F value"],
        p_Hemolysis = anova_int["Hemolysis_Index", "Pr(>F)"],
        F_Interaction = anova_int["Site:Hemolysis_Index", "F value"],
        p_Interaction = anova_int["Site:Hemolysis_Index", "Pr(>F)"]
      )
    }
  )

  ## -----------------------------
  ## Diagnostics (always computed)
  ## -----------------------------
  interaction_diagnostic <- map_df(
    head(biomarkers_with_site_effect$Biomarker, 15),
    function(biom) {

      model_data <- df_hemo %>%
        select(Site, Hemolysis_Index, all_of(biom)) %>%
        drop_na() %>%
        mutate(Site = droplevels(factor(Site)))

      tibble(
        Biomarker = biom,
        n_samples = nrow(model_data),
        n_sites = nlevels(model_data$Site),
        hemo_sd = if (nrow(model_data) > 1)
  sd(model_data$Hemolysis_Index)
else
  NA_real_
      )
    }
  )

  ## -----------------------------
  ## Output
  ## -----------------------------
  cat("Site × Hemolysis interactions:\n\n")

  if (nrow(interaction_results) > 0) {

    interaction_results %>%
      arrange(p_Interaction) %>%
      kbl(digits = 4, format = "html") %>%
      kable_styling(
        bootstrap_options = c("striped", "hover", "condensed")
      )

    sig_int <- interaction_results %>%
      filter(p_Interaction < 0.05)

    if (nrow(sig_int) > 0) {
      cat("\n\n**Biomarkers with significant Site × Hemolysis interaction:**\n")
      cat("Hemolysis affects these biomarkers differently across Sites\n\n")
      kable(sig_int %>% select(Biomarker, F_Interaction, p_Interaction))
    }

  } } else {

  cat("No estimable Site × Hemolysis interactions for the selected biomarkers.\n\n")

  if (nrow(interaction_diagnostic) > 0) {

    cat("Diagnostics:\n")

    knitr::kable(
      interaction_diagnostic,
      digits = 3,
      caption = "Why Site × Hemolysis interactions were not estimable"
    )

  } else {

    cat("No diagnostic data available (all biomarkers filtered during preprocessing).\n")
  }
}
```

# 7. Sex Differences in Hemolysis by Site

G6PD deficiency (which causes hemolysis) is X-linked and more common in males. It's also more prevalent in certain populations (African, African-American, Mediterranean). If hemolysis differences are biological rather than pre-analytical, we might see sex effects.

```{r sex-differences, results='asis', fig.width=10, fig.height=6}
# Check if sex variable exists and has data
if ("sex" %in% names(df_hemo) && sum(!is.na(df_hemo$sex)) > 50) {

  df_sex <- df_hemo %>%
    filter(!is.na(sex), sex %in% c("M", "F", "Male", "Female", "1", "2")) %>%
    mutate(Sex = case_when(
      sex %in% c("M", "Male", "1") ~ "Male",
      sex %in% c("F", "Female", "2") ~ "Female",
      TRUE ~ NA_character_
    )) %>%
    filter(!is.na(Sex))

  cat("## 7.1 Overall Sex Effect\n\n")

  # Overall sex effect
  sex_summary <- df_sex %>%
    group_by(Sex) %>%
    summarise(
      N = n(),
      Mean = mean(Hemolysis_Index, na.rm = TRUE),
      SD = sd(Hemolysis_Index, na.rm = TRUE),
      Median = median(Hemolysis_Index, na.rm = TRUE),
      .groups = "drop"
    )

  kable(sex_summary, digits = 3)

  # T-test
  if (length(unique(df_sex$Sex)) == 2) {
    t_result <- t.test(Hemolysis_Index ~ Sex, data = df_sex)
    cat("\n\n**T-test:** t =", round(t_result$statistic, 3),
        ", p =", format.pval(t_result$p.value, digits = 3), "\n")

    if (t_result$p.value < 0.05) {
      cat("→ Significant sex difference in hemolysis (potential G6PD effect)\n\n")
    } else {
      cat("→ No significant sex difference overall\n\n")
    }
  }

  cat("\n\n## 7.2 Sex × Site Interaction\n\n")
  cat("Testing if sex effects on hemolysis vary by Site:\n\n")

  # Sex by Site interaction
  sites_for_sex <- df_sex %>%
    count(Site, Sex) %>%
    pivot_wider(names_from = Sex, values_from = n, values_fill = 0) %>%
    filter(Male >= 5, Female >= 5) %>%
    pull(Site)

  if (length(sites_for_sex) >= 2) {
    df_sex_site <- df_sex %>%
      filter(Site %in% sites_for_sex) %>%
      mutate(Site = droplevels(factor(Site)))

    lm_sex_site <- lm(Hemolysis_Index ~ Site * Sex, data = df_sex_site)
    anova_sex_site <- Anova(lm_sex_site, type = "II")

    print(kable(tidy(anova_sex_site), digits = 4))

    cat("\n\n**Interpretation:**\n")
    cat("- Site:Sex interaction p < 0.05: Sex effect differs across Sites\n")
    cat("- This could indicate Site-specific population differences in G6PD\n\n")

    # Visualization
    print(ggplot(df_sex_site, aes(x = reorder(Site, Hemolysis_Index, median),
                            y = Hemolysis_Index, fill = Sex)) +
      geom_boxplot(alpha = 0.7, position = position_dodge(0.8)) +
      coord_flip() +
      theme_minimal() +
      scale_fill_manual(values = c("Female" = "#E69F00", "Male" = "#56B4E9")) +
      labs(title = "Hemolysis Index by Site and Sex",
           subtitle = "Testing for sex differences (potential G6PD effect)",
           x = "Site", y = "Hemolysis Index"))

  } else {
    cat("Insufficient data for Sex × Site analysis (need ≥5 M and F per Site)\n")
  }

  cat("\n## 7.3 Sex Differences Within Each Site\n\n")

  sex_by_site <- map_df(sites_for_sex, function(s) {
    site_data <- df_sex %>% filter(Site == s)
    if (length(unique(site_data$Sex)) == 2 &&
        sum(site_data$Sex == "Male") >= 5 &&
        sum(site_data$Sex == "Female") >= 5) {
      t_res <- t.test(Hemolysis_Index ~ Sex, data = site_data)
      means <- site_data %>%
        group_by(Sex) %>%
        summarise(Mean = mean(Hemolysis_Index, na.rm = TRUE), .groups = "drop")
      tibble(
        Site = s,
        N_Male = sum(site_data$Sex == "Male"),
        N_Female = sum(site_data$Sex == "Female"),
        Mean_Male = means$Mean[means$Sex == "Male"],
        Mean_Female = means$Mean[means$Sex == "Female"],
        Diff = Mean_Male - Mean_Female,
        p_value = t_res$p.value
      )
    } else {
      NULL
    }
  })

  if (nrow(sex_by_site) > 0) {
    print(sex_by_site %>%
      mutate(FDR = p.adjust(p_value, method = "fdr")) %>%
      arrange(p_value) %>%
      kbl(digits = 3, format = "html") %>%
      kable_styling(bootstrap_options = c("striped", "hover", "condensed")))

    cat("\n\n**Interpretation:**\n")
    cat("- Positive Diff: Males have higher hemolysis (consistent with G6PD)\n")
    cat("- Sites with significant sex differences may have biological hemolysis\n")
  }

} else {
  cat("Sex variable not available or insufficient data\n")
}
```

# 8. Covariate Associations with Hemolysis

Testing if demographic/clinical covariates correlate with hemolysis within Sites. Associations that persist across Sites may indicate biological rather than pre-analytical effects.

```{r covariate-associations, results='asis', fig.width=12, fig.height=10}
# Define covariates to test
covariates <- c("RUN", "Race", "sex", "age_at_subject", "CDX", "AOO", "BMI")
covariates_available <- intersect(covariates, names(df_hemo))

cat("Available covariates:", paste(covariates_available, collapse = ", "), "\n\n")

if (length(covariates_available) > 0) {

  cat("## 8.1 Overall Covariate Associations\n\n")

  covar_results <- map_df(covariates_available, function(covar) {

    test_data <- df_hemo %>%
      select(Hemolysis_Index, all_of(covar)) %>%
      drop_na()

    if (nrow(test_data) < 30) {
      return(tibble(Covariate = covar, Test = NA, Statistic = NA, p_value = NA, Note = "Insufficient data"))
    }

    covar_vals <- test_data[[covar]]

    # Determine if numeric or categorical
    if (is.numeric(covar_vals) && length(unique(covar_vals)) > 10) {
      # Correlation for continuous
      cor_res <- cor.test(test_data$Hemolysis_Index, covar_vals, method = "pearson")
      tibble(
        Covariate = covar,
        Test = "Pearson r",
        Statistic = cor_res$estimate,
        p_value = cor_res$p.value,
        Note = paste("N =", nrow(test_data))
      )
    } else {
      # ANOVA for categorical
      test_data$covar_factor <- factor(covar_vals)
      if (nlevels(test_data$covar_factor) < 2) {
        return(tibble(Covariate = covar, Test = NA, Statistic = NA, p_value = NA, Note = "Only 1 level"))
      }
      lm_fit <- lm(Hemolysis_Index ~ covar_factor, data = test_data)
      anova_res <- Anova(lm_fit, type = "II")
      tibble(
        Covariate = covar,
        Test = "ANOVA F",
        Statistic = anova_res$`F value`[1],
        p_value = anova_res$`Pr(>F)`[1],
        Note = paste("N =", nrow(test_data), ", levels =", nlevels(test_data$covar_factor))
      )
    }
  })

  print(covar_results %>%
    arrange(p_value) %>%
    kbl(digits = 4, format = "html") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed")))

  cat("\n\n## 8.2 Covariate Associations Within Sites\n\n")
  cat("Testing covariates within each Site to identify consistent patterns:\n\n")

  # Focus on numeric covariates for within-site correlations
  numeric_covars <- covariates_available[sapply(df_hemo[covariates_available], function(x) {
    is.numeric(x) && length(unique(na.omit(x))) > 5
  })]

  if (length(numeric_covars) > 0) {

    within_site_cors <- map_df(sites_with_data, function(s) {
      site_data <- df_hemo %>% filter(Site == s)

      map_df(numeric_covars, function(covar) {
        test_data <- site_data %>%
          select(Hemolysis_Index, all_of(covar)) %>%
          drop_na()

        if (nrow(test_data) >= 20) {
          cor_res <- cor.test(test_data$Hemolysis_Index, test_data[[covar]], method = "pearson")
          tibble(
            Site = s,
            Covariate = covar,
            N = nrow(test_data),
            r = cor_res$estimate,
            p_value = cor_res$p.value
          )
        } else {
          NULL
        }
      })
    })

    if (nrow(within_site_cors) > 0) {
      # Summarize across Sites
      covar_consistency <- within_site_cors %>%
        group_by(Covariate) %>%
        summarise(
          N_Sites = n(),
          Mean_r = mean(r, na.rm = TRUE),
          SD_r = sd(r, na.rm = TRUE),
          N_Significant = sum(p_value < 0.05, na.rm = TRUE),
          Consistent_Direction = sum(r > 0) == n() | sum(r < 0) == n(),
          .groups = "drop"
        ) %>%
        arrange(desc(abs(Mean_r)))

      cat("**Summary of within-Site correlations:**\n\n")
      print(kable(covar_consistency, digits = 3))

      cat("\n\n**Interpretation:**\n")
      cat("- Consistent_Direction = TRUE: Effect is in same direction across all Sites (likely biological)\n")
      cat("- High N_Significant: Covariate reliably associated with hemolysis\n\n")

      # Detailed table
      cat("\n**Detailed within-Site correlations:**\n\n")
      print(within_site_cors %>%
        arrange(Covariate, Site) %>%
        kbl(digits = 3, format = "html") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")))
    }
  }

  cat("\n\n## 8.3 Visualization of Key Covariates\n\n")

  # Plot age and BMI if available
  plot_list <- list()

  if ("age_at_subject" %in% names(df_hemo)) {
    p_age <- ggplot(df_hemo %>% filter(!is.na(age_at_subject)),
                    aes(x = age_at_subject, y = Hemolysis_Index)) +
      geom_point(alpha = 0.3) +
      geom_smooth(method = "lm", color = "red") +
      facet_wrap(~Site, scales = "free") +
      theme_minimal() +
      labs(title = "Hemolysis vs Age by Site", x = "Age", y = "Hemolysis Index")
    plot_list$age <- p_age
  }

  if ("BMI" %in% names(df_hemo)) {
    p_bmi <- ggplot(df_hemo %>% filter(!is.na(BMI), BMI > 10, BMI < 60),
                    aes(x = BMI, y = Hemolysis_Index)) +
      geom_point(alpha = 0.3) +
      geom_smooth(method = "lm", color = "blue") +
      facet_wrap(~Site, scales = "free") +
      theme_minimal() +
      labs(title = "Hemolysis vs BMI by Site", x = "BMI", y = "Hemolysis Index")
    plot_list$bmi <- p_bmi
  }

  if (length(plot_list) > 0) {
    for (p in plot_list) print(p)
  }

} else {
  cat("No covariates available for analysis\n")
}
```

# 9. Outlier Detection

Flag samples with unusually high hemolysis, both overall and within each Site.

```{r outlier-detection, results='asis', fig.width=10, fig.height=6}
cat("## 9.1 Overall Outliers\n\n")

# Calculate overall thresholds
overall_mean <- mean(df_hemo$Hemolysis_Index, na.rm = TRUE)
overall_sd <- sd(df_hemo$Hemolysis_Index, na.rm = TRUE)
overall_median <- median(df_hemo$Hemolysis_Index, na.rm = TRUE)
overall_iqr <- IQR(df_hemo$Hemolysis_Index, na.rm = TRUE)

# Multiple outlier definitions
df_hemo <- df_hemo %>%
  mutate(
    Outlier_2SD = Hemolysis_Index > (overall_mean + 2 * overall_sd),
    Outlier_3SD = Hemolysis_Index > (overall_mean + 3 * overall_sd),
    Outlier_IQR = Hemolysis_Index > (overall_median + 1.5 * overall_iqr)
  )

outlier_summary <- tibble(
  Method = c("Mean + 2 SD", "Mean + 3 SD", "Median + 1.5 IQR"),
  Threshold = c(overall_mean + 2 * overall_sd,
                overall_mean + 3 * overall_sd,
                overall_median + 1.5 * overall_iqr),
  N_Flagged = c(sum(df_hemo$Outlier_2SD),
                sum(df_hemo$Outlier_3SD),
                sum(df_hemo$Outlier_IQR)),
  Pct_Flagged = c(mean(df_hemo$Outlier_2SD) * 100,
                  mean(df_hemo$Outlier_3SD) * 100,
                  mean(df_hemo$Outlier_IQR) * 100)
)

kable(outlier_summary, digits = 3)

cat("\n\n## 9.2 Site-Specific Outliers\n\n")
cat("Using site-specific Mean + 2 SD threshold:\n\n")

# Calculate site-specific outliers
df_hemo <- df_hemo %>%
  group_by(Site) %>%
  mutate(
    Site_Mean = mean(Hemolysis_Index, na.rm = TRUE),
    Site_SD = sd(Hemolysis_Index, na.rm = TRUE),
    Site_Threshold = Site_Mean + 2 * Site_SD,
    Outlier_Site_2SD = Hemolysis_Index > Site_Threshold,
    Z_Score_Site = (Hemolysis_Index - Site_Mean) / Site_SD
  ) %>%
  ungroup()

site_outlier_summary <- df_hemo %>%
  group_by(Site) %>%
  summarise(
    N = n(),
    Mean = mean(Hemolysis_Index, na.rm = TRUE),
    SD = sd(Hemolysis_Index, na.rm = TRUE),
    Threshold_2SD = first(Site_Threshold),
    N_Outliers = sum(Outlier_Site_2SD, na.rm = TRUE),
    Pct_Outliers = mean(Outlier_Site_2SD, na.rm = TRUE) * 100,
    .groups = "drop"
  ) %>%
  arrange(desc(Pct_Outliers))

site_outlier_summary %>%
  kbl(digits = 3, format = "html") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))

cat("\n\n## 9.3 Outlier Visualization\n\n")

# Histogram with thresholds
ggplot(df_hemo, aes(x = Hemolysis_Index)) +
  geom_histogram(bins = 50, fill = "steelblue", alpha = 0.7) +
  geom_vline(xintercept = overall_mean + 2 * overall_sd, color = "orange", linetype = "dashed", linewidth = 1) +
  geom_vline(xintercept = overall_mean + 3 * overall_sd, color = "red", linetype = "dashed", linewidth = 1) +
  theme_minimal() +
  labs(title = "Distribution of Hemolysis Index with Outlier Thresholds",
       subtitle = "Orange = Mean + 2 SD, Red = Mean + 3 SD",
       x = "Hemolysis Index", y = "Count")

cat("\n\n## 9.4 Samples Flagged as Outliers\n\n")

# List outlier samples (using 2 SD threshold)
outlier_samples <- df_hemo %>%
  filter(Outlier_2SD) %>%
  select(any_of(c("SAMPLE", "SAMPLE_ALIQUOT", "Site", "Hemolysis_Index", "Z_Score_Site"))) %>%
  arrange(desc(Hemolysis_Index))

cat("Samples flagged (Overall 2 SD):", nrow(outlier_samples), "\n\n")

if (nrow(outlier_samples) > 0 && nrow(outlier_samples) <= 50) {
  outlier_samples %>%
    kbl(digits = 3, format = "html") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
} else if (nrow(outlier_samples) > 50) {
  cat("Showing top 50 outliers:\n\n")
  head(outlier_samples, 50) %>%
    kbl(digits = 3, format = "html") %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
}

# Save outlier flags to output
df_hemo %>%
  select(any_of(c(intersect(metadata_cols, names(.)),
                  hemolysis_available,
                  "Hemolysis_Index", "Outlier_2SD", "Outlier_3SD",
                  "Outlier_Site_2SD", "Z_Score_Site"))) %>%
  write_csv("output_files/hemo_data_with_outliers.csv")

cat("\n\nOutlier flags saved to output_files/hemo_data_with_outliers.csv\n")
```

# 10. Technical Replicate Baseline Variance

Using HIHG technical replicates to establish baseline (technical) variance for hemolysis markers. Variance in real samples that exceeds this baseline and correlates with HBA1 is likely hemolysis-driven rather than technical noise.

```{r replicate-variance, results='asis', fig.width=10, fig.height=8}
# Load replicate data
rep_file <- "../Primary_QC/output_files/hihg_reps_NPQ.csv"

if (file.exists(rep_file)) {

  df_reps <- read_csv(rep_file, show_col_types = FALSE)
  cat("Loaded replicate data:", nrow(df_reps), "samples\n\n")

  # Check which hemolysis markers are in replicate data
  hemo_in_reps <- intersect(hemolysis_markers, names(df_reps))
  cat("Hemolysis markers in replicate data:", paste(hemo_in_reps, collapse = ", "), "\n\n")

  if (length(hemo_in_reps) >= 3) {

    cat("## 10.1 Technical Variance (CV) from Replicates\n\n")

    # Calculate CV for each marker across replicates
    # Assuming replicates are from the same individuals run multiple times
    rep_stats <- map_df(hemo_in_reps, function(marker) {
      vals <- df_reps[[marker]]
      vals <- vals[!is.na(vals) & vals > 0]

      if (length(vals) >= 10) {
        tibble(
          Marker = marker,
          N = length(vals),
          Mean = mean(vals),
          SD = sd(vals),
          CV_pct = (sd(vals) / mean(vals)) * 100,
          Range = max(vals) - min(vals)
        )
      } else {
        NULL
      }
    })

    cat("**Technical variance (CV%) from replicates:**\n\n")
    print(kable(rep_stats, digits = 3))

    cat("\n\n## 10.2 Compare Sample Variance to Technical Baseline\n\n")

    # Calculate variance in main data
    sample_stats <- map_df(hemo_in_reps, function(marker) {
      if (marker %in% names(df_hemo)) {
        vals <- df_hemo[[marker]]
        vals <- vals[!is.na(vals) & vals > 0]

        tibble(
          Marker = marker,
          Sample_N = length(vals),
          Sample_Mean = mean(vals),
          Sample_SD = sd(vals),
          Sample_CV_pct = (sd(vals) / mean(vals)) * 100
        )
      } else {
        NULL
      }
    })

    # Merge and compare
    if (nrow(sample_stats) > 0 && nrow(rep_stats) > 0) {
      variance_comparison <- rep_stats %>%
        select(Marker, Tech_CV = CV_pct) %>%
        inner_join(
          sample_stats %>% select(Marker, Sample_CV = Sample_CV_pct),
          by = "Marker"
        ) %>%
        mutate(
          Excess_CV = Sample_CV - Tech_CV,
          CV_Ratio = Sample_CV / Tech_CV,
          Likely_Biological = CV_Ratio > 1.5
        )

      cat("**Comparison of sample variance to technical baseline:**\n\n")
      print(variance_comparison %>%
        kbl(digits = 2, format = "html") %>%
        kable_styling(bootstrap_options = c("striped", "hover", "condensed")))

      cat("\n\n**Interpretation:**\n")
      cat("- CV_Ratio > 1.5: Sample variance exceeds technical noise (biological variation)\n")
      cat("- CV_Ratio ~ 1: Variance is mostly technical\n")
      cat("- Excess_CV: How much additional variance exists beyond technical noise\n\n")
    }

    cat("\n## 10.3 HBA1 Correlation Analysis\n\n")
    cat("Biomarkers whose excess variance correlates with HBA1 are likely hemolysis-affected:\n\n")

    # For all biomarkers, correlate with HBA1
    if ("HBA1" %in% names(df_hemo)) {

      # Get biomarkers that are also in replicate data (so we have tech variance)
      biomarkers_in_both <- intersect(biomarker_cols, names(df_reps))

      # Calculate correlation with HBA1 for each biomarker
      hba1_cors <- map_df(biomarkers_in_both, function(biom) {
        test_data <- df_hemo %>%
          select(HBA1, all_of(biom)) %>%
          drop_na()

        if (nrow(test_data) >= 50) {
          cor_res <- cor.test(test_data$HBA1, test_data[[biom]], method = "pearson")

          # Also get tech CV if available
          rep_vals <- df_reps[[biom]]
          rep_vals <- rep_vals[!is.na(rep_vals) & rep_vals > 0]
          tech_cv <- if (length(rep_vals) >= 10) (sd(rep_vals) / mean(rep_vals)) * 100 else NA

          # Sample CV
          sample_vals <- test_data[[biom]]
          sample_cv <- (sd(sample_vals) / mean(sample_vals)) * 100

          tibble(
            Biomarker = biom,
            r_HBA1 = cor_res$estimate,
            p_HBA1 = cor_res$p.value,
            Tech_CV = tech_cv,
            Sample_CV = sample_cv,
            Excess_CV = if (!is.na(tech_cv)) sample_cv - tech_cv else NA
          )
        } else {
          NULL
        }
      })

      if (nrow(hba1_cors) > 0) {
        # Flag likely hemolysis-affected biomarkers
        hba1_cors <- hba1_cors %>%
          mutate(
            FDR = p.adjust(p_HBA1, method = "fdr"),
            Hemolysis_Affected = abs(r_HBA1) > 0.3 & FDR < 0.05 &
                                 (is.na(Excess_CV) | Excess_CV > 5)
          ) %>%
          arrange(desc(abs(r_HBA1)))

        cat("**Top biomarkers correlated with HBA1:**\n\n")
        print(head(hba1_cors, 20) %>%
          kbl(digits = 3, format = "html") %>%
          kable_styling(bootstrap_options = c("striped", "hover", "condensed")))

        cat("\n\n**Likely hemolysis-affected biomarkers:**\n")
        cat("(|r| > 0.3, FDR < 0.05, and excess variance > 5%)\n\n")

        affected <- hba1_cors %>% filter(Hemolysis_Affected)
        if (nrow(affected) > 0) {
          print(kable(affected %>% select(Biomarker, r_HBA1, FDR, Excess_CV), digits = 3))
        } else {
          cat("No biomarkers meet all criteria for hemolysis-affected.\n")
        }

        # Visualization
        cat("\n\n## 10.4 Visualization: HBA1 Correlation vs Excess Variance\n\n")

        hba1_cors_plot <- hba1_cors %>% filter(!is.na(Excess_CV))

        if (nrow(hba1_cors_plot) > 10) {
          print(ggplot(hba1_cors_plot, aes(x = Excess_CV, y = abs(r_HBA1))) +
            geom_point(aes(color = Hemolysis_Affected), alpha = 0.6) +
            geom_hline(yintercept = 0.3, linetype = "dashed", color = "red") +
            geom_vline(xintercept = 5, linetype = "dashed", color = "red") +
            geom_text(data = hba1_cors_plot %>% filter(Hemolysis_Affected),
                      aes(label = Biomarker), hjust = -0.1, size = 3) +
            scale_color_manual(values = c("FALSE" = "gray50", "TRUE" = "red")) +
            theme_minimal() +
            labs(title = "Identifying Hemolysis-Affected Biomarkers",
                 subtitle = "Biomarkers in upper-right quadrant are likely hemolysis-affected",
                 x = "Excess CV (Sample CV - Technical CV)",
                 y = "|Correlation with HBA1|",
                 color = "Likely Affected"))
        }

        # Save results
        hba1_cors %>%
          write_csv("output_files/biomarker_hemolysis_assessment.csv")
        cat("\n\nResults saved to output_files/biomarker_hemolysis_assessment.csv\n")
      }
    }

  } else {
    cat("Insufficient hemolysis markers in replicate data for analysis\n")
  }

} else {
  cat("Replicate data file not found:", rep_file, "\n")
  cat("Skipping technical variance analysis.\n")
}
```

# 11. Summary

```{r summary, results='asis'}
cat("## KEY FINDINGS\n\n")

anova_hemo_safe       <- get0("anova_hemo", ifnotfound = NULL)
marker_results_safe   <- get0("marker_results", ifnotfound = NULL)
likely_artifacts_safe <- get0("likely_artifacts", ifnotfound = NULL)
sig_int_safe          <- get0("sig_int", ifnotfound = NULL)
sex_by_site_safe      <- get0("sex_by_site", ifnotfound = NULL)
covar_results_safe    <- get0("covar_results", ifnotfound = NULL)
outlier_summary_safe  <- get0("outlier_summary", ifnotfound = NULL)
hba1_cors_safe        <- get0("hba1_cors", ifnotfound = NULL)

## 1. Hemolysis by Site
cat("1. HEMOLYSIS BY SITE:\n")
if (is.data.frame(anova_hemo_safe) &&
    nrow(anova_hemo_safe) > 0 &&
    "Pr(>F)" %in% colnames(anova_hemo_safe) &&
    !is.na(anova_hemo_safe$`Pr(>F)`[1]) &&
    anova_hemo_safe$`Pr(>F)`[1] < 0.05) {

  cat("   ✓ Hemolysis varies significantly by Site (p < 0.05)\n")
  cat("   → Pre-analytical differences exist across Sites\n")

} else {

  cat("   ○ Hemolysis similar across Sites\n")
  cat("   → Sample handling appears consistent\n")
}

## 2. Individual markers
cat("\n2. INDIVIDUAL MARKERS:\n")
if (is.data.frame(marker_results_safe) &&
    "p_value" %in% colnames(marker_results_safe) &&
    nrow(marker_results_safe) > 0) {

  sig_markers <- sum(marker_results_safe$p_value < 0.05, na.rm = TRUE)
  cat("   ", sig_markers, "/", nrow(marker_results_safe),
      "markers vary significantly by Site\n")

} else {

  cat("   ○ Marker-level Site tests not available\n")
}

## 3. Biomarker confounding
cat("\n3. BIOMARKER CONFOUNDING:\n")
if (is.data.frame(likely_artifacts_safe) &&
    nrow(likely_artifacts_safe) > 0) {

  cat("   ⚠ ", nrow(likely_artifacts_safe),
      "biomarkers show >50% F-reduction\n")
  cat("   → Site differences likely technical artifacts\n")

} else {

  cat("   ✓ Site differences appear biological (not hemolysis)\n")
}

## 4. Site × Hemolysis interactions
cat("\n4. SITE-SPECIFIC HEMOLYSIS EFFECTS:\n")
if (is.data.frame(sig_int_safe) &&
    nrow(sig_int_safe) > 0) {

  cat("   ⚠ ", nrow(sig_int_safe),
      "biomarkers show Site × Hemolysis interaction\n")
  cat("   → Hemolysis confounding differs across Sites\n")

} else {

  cat("   ✓ Hemolysis effects consistent across Sites\n")
}

## 5. Sex differences
cat("\n5. SEX DIFFERENCES (potential G6PD effect):\n")
if (is.data.frame(sex_by_site_safe) && nrow(sex_by_site_safe) > 0) {
  sig_sex_sites <- sum(sex_by_site_safe$p_value < 0.05, na.rm = TRUE)
  if (sig_sex_sites > 0) {
    cat("   ⚠ ", sig_sex_sites, "Sites show significant sex differences in hemolysis\n")
    cat("   → May indicate biological hemolysis (G6PD deficiency more common in males)\n")
  } else {
    cat("   ○ No significant sex differences detected\n")
  }
} else {
  cat("   ○ Sex analysis not performed\n")
}

## 6. Outliers
cat("\n6. OUTLIER SAMPLES:\n")
if (is.data.frame(outlier_summary_safe) && nrow(outlier_summary_safe) > 0) {
  n_outliers_2sd <- outlier_summary_safe$N_Flagged[outlier_summary_safe$Method == "Mean + 2 SD"]
  pct_outliers <- outlier_summary_safe$Pct_Flagged[outlier_summary_safe$Method == "Mean + 2 SD"]
  cat("   ", n_outliers_2sd, "samples flagged (", round(pct_outliers, 1), "% at 2 SD threshold)\n")
  cat("   → See output_files/hemo_data_with_outliers.csv\n")
} else {
  cat("   ○ Outlier analysis not performed\n")
}

## 7. Technical vs biological variance
cat("\n7. TECHNICAL VS BIOLOGICAL VARIANCE:\n")
if (is.data.frame(hba1_cors_safe) && nrow(hba1_cors_safe) > 0) {
  n_affected <- sum(hba1_cors_safe$Hemolysis_Affected, na.rm = TRUE)
  cat("   ", n_affected, "biomarkers likely affected by hemolysis\n")
  cat("   → (High HBA1 correlation + excess variance beyond technical noise)\n")
  cat("   → See output_files/biomarker_hemolysis_assessment.csv\n")
} else {
  cat("   ○ Technical variance analysis not performed\n")
}

cat("\n\nRECOMMENDATIONS:\n")
cat("- Flag samples with high hemolysis (e.g., Hemolysis_Index > mean + 2 SD)\n")
cat("- Consider sensitivity analyses excluding high-hemolysis samples\n")
cat("- For Site comparisons, adjust for hemolysis when appropriate\n")
cat("- Investigate sample handling at Sites with elevated hemolysis\n")
cat("- For biomarkers identified as hemolysis-affected, use HBA1 as covariate\n")
cat("- Sites with sex differences may have biological rather than pre-analytical hemolysis\n")

```

# Analysis Notes

```{r notes, results='asis'}
notes_file <- "notes.md"
if (file.exists(notes_file)) {
  notes_content <- readLines(notes_file, warn = FALSE)
  cat(paste(notes_content, collapse = "\n"))
} else {
  cat("*No notes.md file found.*\n")
}
```

# Session Info

```{r session-info}
sessionInfo()
```
